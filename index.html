<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TakeMyTag Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .balance-card {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .balance-amount {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #2481cc);
        }

        .section-title {
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 15px;
        }

        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-hint-color, #999999);
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            box-sizing: border-box;
            outline: none;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        button:active {
            opacity: 0.8;
        }

        .lot-card {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>

    <div class="header">
        <div id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="balance-card">
        <div>–í–∞—à –±–∞–ª–∞–Ω—Å</div>
        <div class="balance-amount" id="user-balance">0.00 TON</div>
    </div>

    <div class="section-title">–í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–¥–∞–∂—É</div>
    <div class="input-group">
        <input type="text" id="username-input" placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º (–Ω–∞–ø—Ä–∏–º–µ—Ä: my_tag)">
    </div>
    <div class="input-group">
        <input type="number" id="price-input" placeholder="–¶–µ–Ω–∞ –≤ TON">
    </div>
    <button onclick="createLot()">–í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –º–∞—Ä–∫–µ—Ç</button>

    <div class="section-title" style="margin-top: 30px;">–ê–∫—Ç–∏–≤–Ω—ã–µ –ª–æ—Ç—ã</div>
    <div id="lots-container">
        </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); 

        // üîó –¢–≤–æ—è –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –∏–∑ Ngrok
        const API_URL = "https://rapt-noella-myriadly.ngrok-free.dev/api";
        const user = tg.initDataUnsafe.user;

        // üîë –¢–æ—Ç —Å–∞–º—ã–π "–∫–ª—é—á", –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∫–ª—é—á–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ngrok
        const requestHeaders = {
            'Content-Type': 'application/json',
            'ngrok-skip-browser-warning': 'true'
        };

        if (user) {
            document.getElementById('user-name').innerText = `–ü—Ä–∏–≤–µ—Ç, ${user.first_name}!`;
            fetchUserData();
            fetchLots();
        }

        async function fetchUserData() {
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∑–¥–µ—Å—å
                const response = await fetch(`${API_URL}/users/${user.id}`, {
                    headers: requestHeaders
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('user-balance').innerText = `${data.balance.toFixed(2)} TON`;
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è", e);
            }
        }

        async function fetchLots() {
            try {
                // –ò –∑–¥–µ—Å—å —Ç–æ–∂–µ
                const response = await fetch(`${API_URL}/lots`, {
                    headers: requestHeaders
                });
                if (response.ok) {
                    const lots = await response.json();
                    const container = document.getElementById('lots-container');
                    container.innerHTML = '';
                    
                    if (lots.length === 0) {
                        container.innerHTML = '<div style="color: gray; text-align: center;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–æ—Ç–æ–≤</div>';
                    }

                    lots.forEach(lot => {
                        container.innerHTML += `
                            <div class="lot-card">
                                <div><strong>@${lot.target_username}</strong></div>
                                <div style="color: var(--tg-theme-button-color)">${lot.price} TON</div>
                            </div>
                        `;
                    });
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ—Ç–æ–≤", e);
            }
        }

        async function createLot() {
            const username = document.getElementById('username-input').value.replace('@', '').trim();
            const price = document.getElementById('price-input').value;

            if (!username || !price) {
                tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
                return;
            }

            tg.showConfirm(`–í—ã—Å—Ç–∞–≤–∏—Ç—å @${username} –∑–∞ ${price} TON?`, async (ok) => {
                if (ok) {
                    try {
                        const response = await fetch(`${API_URL}/lots`, {
                            method: 'POST',
                            headers: requestHeaders, // –í–∞–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—é–¥–∞!
                            body: JSON.stringify({
                                user_id: user.id,
                                target_username: username,
                                price: parseFloat(price)
                            })
                        });

                        if (response.ok) {
                            tg.showAlert("‚úÖ –õ–æ—Ç —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –±–æ—Ç—É-—Ö–æ–ª–¥–µ—Ä—É.");
                            document.getElementById('username-input').value = '';
                            document.getElementById('price-input').value = '';
                            fetchLots();
                        } else {
                            tg.showAlert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ª–æ—Ç–∞.");
                        }
                    } catch (e) {
                        tg.showAlert("‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Ngrok!");
                    }
                }
            });
        }

        // –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
        setInterval(fetchLots, 15000);
    </script>
</body>
</html>
