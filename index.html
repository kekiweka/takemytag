<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TakeMyTag Premium Market</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/tonweb/dist/tonweb.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #000000;
            --accent-color: #38bdf8;
            --text-main: #fafafa;
            --text-dim: #a1a1aa;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --premium-color: #8b5cf6; 
            
            --glass-bg: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: 24px;
        }

        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 16px; padding-bottom: 80px; min-height: 100vh; overflow-x: hidden; position: relative; }

        .bg-mesh { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -2; overflow: hidden; background: #050505; }
        .bg-blob-1, .bg-blob-2 { position: absolute; border-radius: 50%; filter: blur(90px); animation: float 20s infinite alternate ease-in-out; }
        .bg-blob-1 { width: 60vw; height: 60vw; background: rgba(139, 92, 246, 0.35); top: -10%; left: -20%; }
        .bg-blob-2 { width: 70vw; height: 70vw; background: rgba(56, 189, 248, 0.25); bottom: -20%; right: -20%; animation-delay: -5s; }
        @keyframes float { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(15vw, 15vh) scale(1.1); } }

        .bg-noise { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; opacity: 0.3; pointer-events: none; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }

        .glass-card { background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--glass-border); border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); transition: transform 0.2s ease, box-shadow 0.2s ease; }

        .balance-card { padding: 20px; text-align: center; margin-bottom: 24px; }
        .input-box { padding: 20px; margin-bottom: 24px; }
        .lot-item { padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        .balance-label { color: var(--text-dim); font-size: 13px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 500;}
        .balance-value { font-size: 32px; font-weight: 800; color: #fff; margin-top: 5px; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        
        input, select { width: 100%; padding: 16px; margin-bottom: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 16px; color: white; font-family: 'Montserrat', sans-serif; font-size: 15px; box-sizing: border-box; outline: none; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--accent-color); background: rgba(0,0,0,0.5); }
        
        button { font-family: 'Montserrat', sans-serif; outline: none; transition: all 0.2s ease; cursor: pointer; }
        button:active { transform: scale(0.96); }

        .btn-main { background: linear-gradient(135deg, #0ea5e9, #2563eb); color: white; border: none; padding: 16px; border-radius: 16px; width: 100%; font-weight: 700; font-size: 15px; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
        .btn-small { padding: 12px; font-size: 13px; border-radius: 12px; }
        .section-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; padding-left: 5px; letter-spacing: -0.5px;}
        
        .vip-lot { border: 1px solid rgba(251, 191, 36, 0.6) !important; box-shadow: 0 4px 25px rgba(251, 191, 36, 0.15); background: linear-gradient(145deg, var(--glass-bg), rgba(251, 191, 36, 0.05)) !important; }
        .vip-badge { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 8px; text-transform: uppercase; letter-spacing: 1px; vertical-align: middle; display: inline-block; box-shadow: 0 2px 10px rgba(251,191,36,0.3); }
        .verified-badge { display: inline-flex; align-items: center; justify-content: center; }
        .buy-btn { background: var(--success); color: white; border: none; padding: 10px 16px; border-radius: 12px; font-weight: 600; white-space: nowrap; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2); }
        
        .tab-content { display: none; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); } 
        .tab-content.active { display: block; }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(15px);} to {opacity: 1; transform: translateY(0);} }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(5, 5, 5, 0.7); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid var(--glass-border); z-index: 100; }
        .nav-item { color: var(--text-dim); font-size: 11px; font-weight: 600; cursor: pointer; transition: 0.3s; text-align: center; } 
        .nav-item.active { color: var(--accent-color); text-shadow: 0 0 10px rgba(56,189,248,0.5); }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 4px; transition: transform 0.2s;}
        .nav-item:active .nav-icon { transform: scale(0.8); }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: rgba(20, 20, 25, 0.95); padding: 30px; border-radius: 32px; width: 85%; max-width: 400px; text-align: center; border: 1px solid var(--glass-border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.03) 75%); background-size: 200% 100%; animation: loading 1.5s infinite linear; border-radius: 8px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        .flex-btns { display: flex; gap: 10px; margin-top: 15px; }
        .btn-cancel { background: transparent; border: 1px solid var(--text-dim); color: var(--text-main); padding: 12px; border-radius: 16px; width: 100%; font-weight: 600; }
        .btn-confirm { background: var(--accent-color); border: none; color: white; padding: 12px; border-radius: 16px; width: 100%; font-weight: 600; }
        
        #toast-container { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); z-index: 99999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .custom-toast { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-left: 4px solid var(--accent-color); color: white; padding: 14px 20px; border-radius: 12px; font-size: 13px; font-weight: 600; box-shadow: 0 10px 25px rgba(0,0,0,0.5); animation: slideDown 0.3s ease-out forwards; opacity: 0; transform: translateY(-20px); }
        .custom-toast.error { border-left-color: var(--error); }
        .custom-toast.success { border-left-color: var(--success); }
        @keyframes slideDown { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }
        .timer-text { font-size: 34px; font-weight: 800; color: #ef4444; margin: 15px 0; letter-spacing: 2px; }
        .step-num { background: var(--accent-color); color: white; width: 26px; height: 26px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 12px; font-weight: bold; }
        .history-container::-webkit-scrollbar { width: 4px; }
        .history-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        #lang-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5,5,5,0.8); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); z-index: 20000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
        .lang-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 20px 40px; font-size: 18px; font-weight: 700; color: white; margin-bottom: 15px; width: 80%; max-width: 300px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.2); font-family: 'Montserrat', sans-serif; cursor: pointer; transition: 0.3s; }
        .lang-btn:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); transform: scale(1.05); }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 15000; display: none; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; overflow: hidden; }
        .loader-logo { width: 120px; height: 120px; border-radius: 25px; box-shadow: 0 0 30px rgba(56, 189, 248, 0.4); margin-bottom: 25px; object-fit: cover; position: relative; z-index: 10; }
        .loader-bar-container { width: 60%; max-width: 250px; height: 6px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; position: relative; z-index: 10;}
        .loader-bar { height: 100%; width: 0%; background: var(--accent-color); border-radius: 10px; box-shadow: 0 0 10px var(--accent-color); transition: width 0.1s linear; }
        
        .floating-tag { position: absolute; font-weight: 800; white-space: nowrap; pointer-events: none; z-index: 1; user-select: none; color: rgba(255, 255, 255, 0.1); animation: floatUp linear infinite; }
        .glow-blue { color: rgba(56, 189, 248, 0.15); text-shadow: 0 0 20px rgba(56, 189, 248, 0.5); }
        .glow-purple { color: rgba(139, 92, 246, 0.15); text-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }

        @keyframes floatUp { 0% { transform: translateY(110vh) scale(0.8); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-30vh) scale(1.1); opacity: 0; } }

        @keyframes fomoPulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* üí° –°—Ç–∏–ª–∏ –¥–ª—è –±–µ–π–¥–∂–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ */
        .loyalty-badge { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; display: inline-block; margin-top: 5px; }
        .bronze { background: linear-gradient(135deg, #b45309, #78350f); color: white; box-shadow: 0 2px 10px rgba(180, 83, 9, 0.3); }
        .silver { background: linear-gradient(135deg, #94a3b8, #475569); color: white; box-shadow: 0 2px 10px rgba(148, 163, 184, 0.3); }
        .gold { background: linear-gradient(135deg, #fbbf24, #d97706); color: black; box-shadow: 0 2px 10px rgba(251, 191, 36, 0.4); }
    </style>
</head>
<body>
    <div class="bg-mesh"><div class="bg-blob-1"></div><div class="bg-blob-2"></div></div>
    <div class="bg-noise"></div>

    <div id="lang-screen">
        <div class="glass-card" style="padding: 40px 20px; text-align: center; width: 85%; max-width: 350px;">
            <div style="font-size: 50px; margin-bottom: 10px;">üåç</div>
            <h2 style="margin-top: 0; margin-bottom: 30px; font-weight: 800; font-size: 22px;">
                Choose Language<br><span style="font-size: 15px; color: var(--text-dim); font-weight: 500;">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</span>
            </h2>
            <button class="lang-btn" onclick="selectLanguage('en')">üá¨üáß English</button>
            <button class="lang-btn" onclick="selectLanguage('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
        </div>
    </div>

    <div id="loader">
        <div class="floating-tag" style="left: 10%; animation-duration: 12s; animation-delay: -2s; font-size: 24px;">@durov</div>
        <div class="floating-tag glow-blue" style="left: 70%; animation-duration: 15s; animation-delay: -7s; font-size: 32px; filter: blur(1px);">@crow</div>
        <div class="floating-tag" style="left: 25%; animation-duration: 10s; animation-delay: -4s; font-size: 20px; filter: blur(2px);">@monk</div>
        <div class="floating-tag" style="left: 80%; animation-duration: 14s; animation-delay: -1s; font-size: 28px;">@crypto</div>
        <div class="floating-tag glow-purple" style="left: 15%; animation-duration: 16s; animation-delay: -9s; font-size: 36px;">@ton</div>
        <div class="floating-tag" style="left: 60%; animation-duration: 11s; animation-delay: -5s; font-size: 22px; filter: blur(1px);">@meta</div>
        <div class="floating-tag" style="left: 40%; animation-duration: 13s; animation-delay: -8s; font-size: 26px;">@nuhao</div>
        <div class="floating-tag" style="left: 85%; animation-duration: 12s; animation-delay: -3s; font-size: 20px; filter: blur(2px);">@family</div>
        <div class="floating-tag" style="left: 5%; animation-duration: 15s; animation-delay: -11s; font-size: 30px;">@fragment</div>
        <div class="floating-tag glow-blue" style="left: 50%; animation-duration: 14s; animation-delay: -6s; font-size: 24px; filter: blur(1px);">@market</div>
        <div style="z-index: 10; display: flex; flex-direction: column; align-items: center; position: relative;">
            <img src="logo.jpg" alt="Logo" class="loader-logo">
            <div style="font-size: 26px; font-weight: 800; margin-bottom: 25px; letter-spacing: 1px; color: white; text-shadow: 0 0 15px rgba(0,0,0,0.5);">TakeMyTag</div>
            <div class="loader-bar-container"><div class="loader-bar" id="loader-bar"></div></div>
            <div style="margin-top: 15px; font-size: 15px; font-weight: bold; color: var(--accent-color);"><span id="loader-percent">0</span>%</div>
        </div>
    </div>

    <div id="toast-container"></div>
    <div id="action-modal" class="modal-overlay"><div class="modal-content" id="action-modal-body"></div></div>
    <div id="ton-connect-button" style="display:flex; justify-content:center; margin-bottom:20px; margin-top:20px;"></div>

    <div id="tab-market" class="tab-content active">
        <div class="balance-card glass-card">
            <div class="balance-label" data-ru="–°—Ç–∞—Ç—É—Å –∫–æ—à–µ–ª—å–∫–∞" data-en="Wallet Status">–°—Ç–∞—Ç—É—Å –∫–æ—à–µ–ª—å–∫–∞</div>
            <div id="wallet-status" class="balance-value" style="font-size: 18px; font-weight: 600; text-shadow: none; color: var(--text-main);" data-ru="–ó–∞–≥—Ä—É–∑–∫–∞..." data-en="Loading...">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <div class="input-box glass-card">
            <div class="section-title" style="margin-top: 0;" data-ru="üíé –ü—Ä–æ–¥–∞—Ç—å —é–∑–µ—Ä–Ω–µ–π–º" data-en="üíé Sell Username">üíé –ü—Ä–æ–¥–∞—Ç—å —é–∑–µ—Ä–Ω–µ–π–º</div>
            <input type="text" id="username-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: tag_name" data-ru="–ù–∞–ø—Ä–∏–º–µ—Ä: tag_name" data-en="Example: tag_name">
            <input type="number" id="price-input" placeholder="–¶–µ–Ω–∞ –≤ TON" data-ru="–¶–µ–Ω–∞ –≤ TON" data-en="Price in TON">
            
            <label style="display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--text-dim); margin-bottom: 15px; cursor: pointer;">
                <input type="checkbox" id="is-private-checkbox" style="width: 20px; height: 20px; margin: 0;"> 
                <span data-ru="üïµÔ∏è‚Äç‚ôÇÔ∏è –°–∫—Ä—ã—Ç–∞—è —Å–¥–µ–ª–∫–∞ (–±–µ–∑ –≤–∏—Ç—Ä–∏–Ω—ã)" data-en="üïµÔ∏è‚Äç‚ôÇÔ∏è Hidden deal (off-market)">üïµÔ∏è‚Äç‚ôÇÔ∏è –°–∫—Ä—ã—Ç–∞—è —Å–¥–µ–ª–∫–∞ (–±–µ–∑ –≤–∏—Ç—Ä–∏–Ω—ã)</span>
            </label>

            <div id="price-calc-hint" style="color: var(--warning); font-size: 13px; margin-top: -5px; margin-bottom: 12px; display: none; text-align: right; font-weight: 600;"></div>
            <button class="btn-main" onclick="openConfirmModal()" data-ru="–í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –º–∞—Ä–∫–µ—Ç" data-en="List on Market">–í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –º–∞—Ä–∫–µ—Ç</button>
        </div>
        
        <div style="margin-bottom: 16px;">
            <div class="section-title" style="margin:0 0 12px 0;" data-ru="üî• –í–∏—Ç—Ä–∏–Ω–∞" data-en="üî• Showcase">üî• –í–∏—Ç—Ä–∏–Ω–∞</div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫ —Ç–µ–≥–∞..." oninput="renderMarket()" style="margin:0; flex: 1;" data-ru="üîç –ü–æ–∏—Å–∫ —Ç–µ–≥–∞..." data-en="üîç Search tag...">
                <select id="filter-select" onchange="renderMarket()" style="width:130px; margin:0; padding:16px 12px; font-size: 13px;">
                    <option value="new" data-ru="–ù–æ–≤—ã–µ" data-en="Newest">–ù–æ–≤—ã–µ</option>
                    <option value="price_asc" data-ru="–ü–æ–¥–µ—à–µ–≤–ª–µ" data-en="Cheapest">–ü–æ–¥–µ—à–µ–≤–ª–µ</option>
                    <option value="price_desc" data-ru="–ü–æ–¥–æ—Ä–æ–∂–µ" data-en="Expensive">–ü–æ–¥–æ—Ä–æ–∂–µ</option>
                    <option value="len_asc" data-ru="–ö–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–≥–∏" data-en="Shortest">–ö–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–≥–∏</option>
                    <option value="len_desc" data-ru="–î–ª–∏–Ω–Ω—ã–µ —Ç–µ–≥–∏" data-en="Longest">–î–ª–∏–Ω–Ω—ã–µ —Ç–µ–≥–∏</option> 
                </select>
            </div>
        </div>
        <div id="lots-container"></div>
    </div>

    <div id="tab-auctions" class="tab-content">
        <div class="input-box glass-card">
            <div class="section-title" style="margin-top: 0;" data-ru="‚è≥ –°–æ–∑–¥–∞—Ç—å –∞—É–∫—Ü–∏–æ–Ω" data-en="‚è≥ Create Auction">‚è≥ –°–æ–∑–¥–∞—Ç—å –∞—É–∫—Ü–∏–æ–Ω</div>
            <input type="text" id="auc-username-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: tag_name" data-ru="–ù–∞–ø—Ä–∏–º–µ—Ä: tag_name" data-en="Example: tag_name">
            <input type="number" id="auc-price-input" placeholder="–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ü–µ–Ω–∞ (TON)" data-ru="–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ü–µ–Ω–∞ (TON)" data-en="Start price (TON)">
            <select id="auc-duration-input">
                <option value="1" data-ru="‚è± –¢–∞–π–º–µ—Ä: 1 —á–∞—Å" data-en="‚è± Timer: 1 hour">‚è± –¢–∞–π–º–µ—Ä: 1 —á–∞—Å</option>
                <option value="2" data-ru="‚è± –¢–∞–π–º–µ—Ä: 2 —á–∞—Å–∞" data-en="‚è± Timer: 2 hours">‚è± –¢–∞–π–º–µ—Ä: 2 —á–∞—Å–∞</option>
                <option value="8" data-ru="‚è± –¢–∞–π–º–µ—Ä: 8 —á–∞—Å–æ–≤" data-en="‚è± Timer: 8 hours">‚è± –¢–∞–π–º–µ—Ä: 8 —á–∞—Å–æ–≤</option>
                <option value="24" data-ru="‚è± –¢–∞–π–º–µ—Ä: 24 —á–∞—Å–∞" data-en="‚è± Timer: 24 hours">‚è± –¢–∞–π–º–µ—Ä: 24 —á–∞—Å–∞</option>
            </select>
            <p style="font-size: 11px; color: var(--text-dim); margin-top: -5px;" data-ru="–õ–∏–º–∏—Ç: –º–∞–∫—Å–∏–º—É–º 5 –∞—É–∫—Ü–∏–æ–Ω–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ." data-en="Limit: max 5 active auctions.">–õ–∏–º–∏—Ç: –º–∞–∫—Å–∏–º—É–º 5 –∞—É–∫—Ü–∏–æ–Ω–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.</p>
            <button class="btn-main" onclick="openConfirmAuctionModal()" data-ru="–í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω" data-en="List on Auction">–í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω</button>
        </div>
        <div class="section-title" style="margin:0 0 12px 0;" data-ru="üî• –ò–¥—É—Ç —Ç–æ—Ä–≥–∏" data-en="üî• Live Auctions">üî• –ò–¥—É—Ç —Ç–æ—Ä–≥–∏</div>
        <div id="auctions-container"></div>
    </div>

    <div id="tab-wtb" class="tab-content">
        <div class="input-box glass-card">
            <div class="section-title" style="margin-top: 0;" data-ru="üì¢ –û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É (WTB)" data-en="üì¢ Request to Buy (WTB)">üì¢ –û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É (WTB)</div>
            <p style="font-size:12px; color:var(--text-dim); margin-top:-10px;" data-ru="–ù–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫–æ–π —Ç–µ–≥ –≤—ã –∏—â–µ—Ç–µ, –∏ –ø—Ä–æ–¥–∞–≤—Ü—ã –ø—Ä–µ–¥–ª–æ–∂–∞—Ç –≤–∞–º –≤–∞—Ä–∏–∞–Ω—Ç—ã." data-en="Describe the tag you want, sellers will offer it.">–ù–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫–æ–π —Ç–µ–≥ –≤—ã –∏—â–µ—Ç–µ, –∏ –ø—Ä–æ–¥–∞–≤—Ü—ã –ø—Ä–µ–¥–ª–æ–∂–∞—Ç –≤–∞–º –≤–∞—Ä–∏–∞–Ω—Ç—ã.</p>
            <input type="text" id="wtb-desc-input" placeholder="–ö–æ–≥–æ –∏—â–µ—Ç–µ? (–Ω–∞–ø—Ä–∏–º–µ—Ä, 4 –±—É–∫–≤—ã)" data-ru="–ö–æ–≥–æ –∏—â–µ—Ç–µ? (–Ω–∞–ø—Ä–∏–º–µ—Ä, 4 –±—É–∫–≤—ã)" data-en="What are you looking for?">
            <input type="number" id="wtb-budget-input" placeholder="–ë—é–¥–∂–µ—Ç (TON)" data-ru="–ë—é–¥–∂–µ—Ç (TON)" data-en="Budget (TON)">
            <button class="btn-main" style="background: linear-gradient(135deg, #10b981, #059669);" onclick="submitWTB()" data-ru="–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É" data-en="Publish Request">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
        <div class="section-title" style="margin:0 0 12px 0;" data-ru="üëÄ –ò—â—É—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å" data-en="üëÄ Looking to buy">üëÄ –ò—â—É—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</div>
        <div id="wtb-container"></div>
    </div>

    <div id="tab-profile" class="tab-content">
        <div class="balance-card glass-card" style="text-align: left;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div class="balance-label" id="profile-name" style="font-size: 16px; color: white; display:flex; align-items:center; justify-content:center; gap:6px;">–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
                <div id="loyalty-badge" class="loyalty-badge bronze" style="display:none;">–£—Ä–æ–≤–µ–Ω—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
            </div>
            
            <div style="display: flex; justify-content: space-between; text-align: center; margin-bottom: 15px; gap:10px;">
                <div style="flex:1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 15px 10px; border-radius: 16px;">
                    <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase; font-weight:600;" data-ru="–î–æ—Å—Ç—É–ø–Ω–æ" data-en="Available">–î–æ—Å—Ç—É–ø–Ω–æ</div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--success); margin-top:4px;" id="avail-balance">0.00 TON</div>
                </div>
                <div style="flex:1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 15px 10px; border-radius: 16px;">
                    <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase; font-weight:600;" data-ru="–í —Ö–æ–ª–¥–µ" data-en="On Hold">–í —Ö–æ–ª–¥–µ</div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--warning); margin-top:4px;" id="froz-balance">0.00 TON</div>
                </div>
            </div>
            
            <div style="background: rgba(56, 189, 248, 0.05); padding: 15px; border-radius: 16px; margin-bottom: 15px; text-align: center; border: 1px dashed rgba(56, 189, 248, 0.3);">
                <div style="font-size: 11px; color: var(--accent-color); text-transform: uppercase; margin-bottom: 5px; font-weight:700;" data-ru="–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –Ω–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞—Ö" data-en="Referral Earnings">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –Ω–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞—Ö</div>
                <div style="font-size: 22px; font-weight: 800; color: white;" id="ref-earnings">0.00 TON</div>
                <button class="btn-main btn-small" id="ref-btn" style="margin-top: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: white;" onclick="copyRefLink()" data-ru="üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞ (1%)" data-en="üîó Invite Friend (1%)">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞ (1%)</button>
            </div>

            <div id="vip-tickets-display" style="display:none; text-align:center; font-size:13px; font-weight:600; color:var(--success); margin-bottom:15px; background:rgba(16,185,129,0.1); padding:10px; border-radius:12px; border: 1px solid rgba(16,185,129,0.3);"></div>

            <button class="btn-main btn-small" style="background: linear-gradient(135deg, #ec4899, #f43f5e); color: white; font-size: 14px; margin-bottom: 10px; font-weight: 800;" onclick="openRadarMenu()" data-ru="üì° –£–º–Ω—ã–π –†–∞–¥–∞—Ä" data-en="üì° Smart Radar">üì° –£–º–Ω—ã–π –†–∞–¥–∞—Ä</button>

            <button class="btn-main btn-small" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; font-size: 14px; margin-bottom: 10px; font-weight: 800;" onclick="openLeaderboardModal()" data-ru="üèÜ –¢–æ–ø –ø—Ä–æ–¥–∞–≤—Ü–æ–≤" data-en="üèÜ Top Sellers">üèÜ –¢–æ–ø –ø—Ä–æ–¥–∞–≤—Ü–æ–≤</button>

            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <button class="btn-main btn-small" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9); flex: 1 1 100%; color: white; font-size: 14px;" onclick="openStarsDepositModal()" data-ru="‚≠êÔ∏è –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å (Stars)" data-en="‚≠êÔ∏è Deposit Stars">‚≠êÔ∏è –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å (Stars)</button>
                <button class="btn-main btn-small" style="background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); flex: 1 1 45%;" onclick="openWithdrawModal()" data-ru="üí∏ –í—ã–≤–æ–¥" data-en="üí∏ Withdraw">üí∏ –í—ã–≤–æ–¥</button>
                <button class="btn-main btn-small" style="background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); flex: 1 1 45%;" onclick="openHistoryModal()" data-ru="üìú –ò—Å—Ç–æ—Ä–∏—è" data-en="üìú History">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
                <button class="btn-main btn-small" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); color: var(--warning); flex: 1 1 100%;" onclick="openOffersModal()" data-ru="ü§ù –ú–æ–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–¢–æ—Ä–≥)" data-en="ü§ù My Offers">ü§ù –ú–æ–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–¢–æ—Ä–≥)</button>
                <button class="btn-main btn-small" style="background: transparent; border: 1px dashed var(--glass-border); flex: 1 1 100%; color: var(--text-dim);" onclick="openPromoModal()" data-ru="üéÅ –í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥" data-en="üéÅ Enter Promo">üéÅ –í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥</button>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <div class="section-title" style="margin:0;" data-ru="–°–ø–∏—Å–∫–∏" data-en="Lists">–°–ø–∏—Å–∫–∏</div>
            <select id="profile-filter-select" onchange="renderProfile()" style="width:145px; margin:0; padding:12px 12px; font-size: 13px;">
                <option value="all" data-ru="–ú–æ–∏ –ª–æ—Ç—ã" data-en="My Lots">–ú–æ–∏ –ª–æ—Ç—ã</option>
                <option value="favorites" style="color: #ef4444; font-weight: bold;" data-ru="‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ" data-en="‚ù§Ô∏è Favorites">‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</option>
                <option value="active" data-ru="–í –ø—Ä–æ–¥–∞–∂–µ" data-en="On Sale">–í –ø—Ä–æ–¥–∞–∂–µ</option>
                <option value="sold" data-ru="–ü—Ä–æ–¥–∞–Ω–Ω—ã–µ" data-en="Sold">–ü—Ä–æ–¥–∞–Ω–Ω—ã–µ</option>
                <option value="closed" data-ru="–ó–∞–±—Ä–∞–Ω–Ω—ã–µ / –û—Ç–º–µ–Ω–∞" data-en="Recalled / Cancelled">–ó–∞–±—Ä–∞–Ω–Ω—ã–µ / –û—Ç–º–µ–Ω–∞</option>
                <option value="new" data-ru="–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ" data-en="Newest First">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                <option value="old" data-ru="–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ" data-en="Oldest First">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
            </select>
        </div>
        <div id="profile-list"></div>
    </div>

    <div id="tab-info" class="tab-content">
        <div class="input-box glass-card" style="line-height: 1.7; color: var(--text-dim); font-size: 14px;">
            <h2 style="color: white; margin-top: 0; font-weight: 800; font-size: 22px;" data-ru="‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" data-en="‚ÑπÔ∏è Information">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <p data-ru='<b style="color:white;">–ö–∞–∫ –ø—Ä–æ–¥–∞—Ç—å —é–∑–µ—Ä–Ω–µ–π–º?</b><br>1. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥ –∏ —Ü–µ–Ω—É –≤ —Ä–∞–∑–¥–µ–ª–µ –ú–∞—Ä–∫–µ—Ç.<br>2. –ù–∞–∂–º–∏—Ç–µ "–í—ã—Å—Ç–∞–≤–∏—Ç—å".<br>3. –ü–µ—Ä–µ–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–∞—à–µ–º—É –±–æ—Ç—É <b style="color:var(--accent-color);">@TakeMyTag1</b> –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç.' 
               data-en='<b style="color:white;">How to sell a username?</b><br>1. Enter tag and price in Market.<br>2. Click "List".<br>3. Transfer ownership to <b style="color:var(--accent-color);">@TakeMyTag1</b> within 5 minutes.'>
               <b style="color:white;">–ö–∞–∫ –ø—Ä–æ–¥–∞—Ç—å —é–∑–µ—Ä–Ω–µ–π–º?</b><br>1. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥ –∏ —Ü–µ–Ω—É –≤ —Ä–∞–∑–¥–µ–ª–µ –ú–∞—Ä–∫–µ—Ç.<br>2. –ù–∞–∂–º–∏—Ç–µ "–í—ã—Å—Ç–∞–≤–∏—Ç—å".<br>3. –ü–µ—Ä–µ–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–∞—à–µ–º—É –±–æ—Ç—É <b style="color:var(--accent-color);">@TakeMyTag1</b> –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç.
            </p>
            <div style="height: 1px; background: var(--glass-border); margin: 15px 0;"></div>
            <p data-ru='<b style="color:white;">–ö–æ–º–∏—Å—Å–∏—è:</b><br>–°–∏—Å—Ç–µ–º–∞ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ–≥–æ <b style="color: var(--accent-color);">3.5%</b> –æ—Ç —Å—É–º–º—ã —Å–¥–µ–ª–∫–∏.' 
               data-en='<b style="color:white;">Market Fee:</b><br>System takes only <b style="color: var(--accent-color);">3.5%</b> of a successful deal.'>
               <b style="color:white;">–ö–æ–º–∏—Å—Å–∏—è:</b><br>–°–∏—Å—Ç–µ–º–∞ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ–≥–æ <b style="color: var(--accent-color);">3.5%</b> –æ—Ç —Å—É–º–º—ã —Å–¥–µ–ª–∫–∏.
            </p>
            <div style="height: 1px; background: var(--glass-border); margin: 15px 0;"></div>
            <p data-ru='<b style="color:white;">üì¢ Live-–∫–∞–Ω–∞–ª —Å–¥–µ–ª–æ–∫:</b><br>–°–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ –∏ –æ—Ç–∑—ã–≤—ã –≤ –Ω–∞—à–µ–º <a href="https://t.me/TakeMyTag_Sales" style="color:var(--accent-color); font-weight:bold; text-decoration:none;">–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º –∫–∞–Ω–∞–ª–µ</a>.' 
               data-en='<b style="color:white;">üì¢ Live Sales Channel:</b><br>Watch real purchases and reviews in our <a href="https://t.me/TakeMyTag_Sales" style="color:var(--accent-color); font-weight:bold; text-decoration:none;">Official Channel</a>.'>
               <b style="color:white;">üì¢ Live-–∫–∞–Ω–∞–ª —Å–¥–µ–ª–æ–∫:</b><br>–°–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ –∏ –æ—Ç–∑—ã–≤—ã –≤ –Ω–∞—à–µ–º <a href="https://t.me/TakeMyTag_Sales" style="color:var(--accent-color); font-weight:bold; text-decoration:none;">–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º –∫–∞–Ω–∞–ª–µ</a>.
            </p>
            <div style="height: 1px; background: var(--glass-border); margin: 15px 0;"></div>
            <p data-ru='<b style="color:white;">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ:</b><br>–ù–∞–∂–∏–º–∞–π—Ç–µ ü§ç –Ω–∞ –≤–∏—Ç—Ä–∏–Ω–µ, —á—Ç–æ–±—ã –æ—Ç–ª–æ–∂–∏—Ç—å —Ç–µ–≥ –∏ –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –µ–≥–æ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ".' 
               data-en='<b style="color:white;">Favorites:</b><br>Click heart icon ü§ç to save items for later in your Profile tab.'>
               <b style="color:white;">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ:</b><br>–ù–∞–∂–∏–º–∞–π—Ç–µ ü§ç –Ω–∞ –≤–∏—Ç—Ä–∏–Ω–µ, —á—Ç–æ–±—ã –æ—Ç–ª–æ–∂–∏—Ç—å —Ç–µ–≥ –∏ –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –µ–≥–æ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ".
            </p>
            <div style="height: 1px; background: var(--glass-border); margin: 15px 0;"></div>
            <p data-ru='<b style="color:white;">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:</b><br>–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏ –ø–æ–ª—É—á–∞–π—Ç–µ <b style="color:var(--success);">1%</b> —Å –∫–∞–∂–¥–æ–π –∏—Ö –ø–æ–∫—É–ø–∫–∏ –≤ –º–∞—Ä–∫–µ—Ç–µ –∏–ª–∏ –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω–µ!' 
               data-en='<b style="color:white;">Referral System:</b><br>Invite friends via link and get <b style="color:var(--success);">1%</b> from every purchase they make!'>
               <b style="color:white;">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:</b><br>–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏ –ø–æ–ª—É—á–∞–π—Ç–µ <b style="color:var(--success);">1%</b> —Å –∫–∞–∂–¥–æ–π –∏—Ö –ø–æ–∫—É–ø–∫–∏ –≤ –º–∞—Ä–∫–µ—Ç–µ –∏–ª–∏ –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω–µ!
            </p>
            <div style="height: 1px; background: var(--glass-border); margin: 15px 0;"></div>
            <p data-ru='<b style="color:white;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ ‚≠êÔ∏è:</b><br>–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á–µ—Ç —Å –ø–æ–º–æ—â—å—é –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö Telegram Stars.' 
               data-en='<b style="color:white;">Deposit Stars ‚≠êÔ∏è:</b><br>You can deposit funds using official Telegram Stars.'>
               <b style="color:white;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ ‚≠êÔ∏è:</b><br>–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á–µ—Ç —Å –ø–æ–º–æ—â—å—é –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö Telegram Stars.
            </p>
        </div>
    </div>

    <div id="tab-admin" class="tab-content">
        <div class="balance-card glass-card">
            <h2 style="margin:0 0 15px 0;" data-ru="üõ† –ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞" data-en="üõ† Admin Panel">üõ† –ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
            <button class="btn-main btn-small" style="background:rgba(255,255,255,0.1); border: 1px solid var(--glass-border); margin-bottom:15px;" onclick="loadAdminStats()" data-ru="–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É üîÑ" data-en="Refresh Stats üîÑ">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É üîÑ</button>
            <div id="admin-stats" style="display:flex; justify-content:space-around; text-align:center; font-size:13px; color:var(--text-main);">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>
        <div class="input-box glass-card">
            <h3 style="margin-top:0; display:flex; justify-content:space-between; align-items:center;">
                <span data-ru="üí∏ –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥" data-en="üí∏ Withdraw Requests">üí∏ –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥</span>
                <button class="btn-main btn-small" style="width:auto; padding:6px 10px; background:rgba(255,255,255,0.1);" onclick="loadAdminWithdrawals()">üîÑ</button>
            </h3>
            <div id="admin-withdrawals" style="max-height: 250px; overflow-y: auto; padding-right:5px;" data-ru="–ù–µ—Ç –∑–∞—è–≤–æ–∫" data-en="No requests">–ù–µ—Ç –∑–∞—è–≤–æ–∫</div>
        </div>
        <div class="input-box glass-card">
            <h3 style="margin-top:0;" data-ru="üí∞ –í—ã–¥–∞—Ç—å –±–∞–ª–∞–Ω—Å (TON)" data-en="üí∞ Add Balance (TON)">üí∞ –í—ã–¥–∞—Ç—å –±–∞–ª–∞–Ω—Å (TON)</h3>
            <input type="number" id="admin-bal-id" placeholder="Telegram ID">
            <input type="number" id="admin-bal-amount" placeholder="–°—É–º–º–∞ (TON)" data-ru="–°—É–º–º–∞ (TON)" data-en="Amount (TON)">
            <button class="btn-main" onclick="adminAddBalance()" data-ru="–í—ã–¥–∞—Ç—å –±–∞–ª–∞–Ω—Å" data-en="Add Balance">–í—ã–¥–∞—Ç—å –±–∞–ª–∞–Ω—Å</button>
        </div>
        <div class="input-box glass-card">
            <h3 style="margin-top:0;" data-ru="‚úÖ –í—ã–¥–∞—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é" data-en="‚úÖ Verify User">‚úÖ –í—ã–¥–∞—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é</h3>
            <input type="number" id="admin-ver-id" placeholder="Telegram ID">
            <button class="btn-main" style="background:var(--premium-color);" onclick="adminVerify()" data-ru="–í—ã–¥–∞—Ç—å –≥–∞–ª–æ—á–∫—É" data-en="Verify">–í—ã–¥–∞—Ç—å –≥–∞–ª–æ—á–∫—É</button>
        </div>
        <div class="input-box glass-card">
            <h3 style="margin-top:0;" data-ru="üéÅ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥" data-en="üéÅ Create Promo">üéÅ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h3>
            <input type="text" id="admin-promo-code" placeholder="–ö–æ–¥ (MEGA2026)" style="text-transform: uppercase;">
            <input type="number" id="admin-promo-uses" placeholder="–ö–æ–ª-–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π" data-ru="–ö–æ–ª-–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π" data-en="Uses limit">
            <input type="number" id="admin-promo-tickets" placeholder="–ö–æ–ª-–≤–æ VIP-–∫—É–ø–æ–Ω–æ–≤" data-ru="–ö–æ–ª-–≤–æ VIP-–∫—É–ø–æ–Ω–æ–≤" data-en="VIP Tickets reward">
            <button class="btn-main" style="background:var(--success);" onclick="adminCreatePromo()" data-ru="–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥" data-en="Create Promo">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('market', this)"><span class="nav-icon">üõí</span><span data-ru="–ú–∞—Ä–∫–µ—Ç" data-en="Market">–ú–∞—Ä–∫–µ—Ç</span></div>
        <div class="nav-item" onclick="switchTab('auctions', this)"><span class="nav-icon">‚è≥</span><span data-ru="–¢–æ—Ä–≥–∏" data-en="Auctions">–¢–æ—Ä–≥–∏</span></div>
        <div class="nav-item" onclick="switchTab('wtb', this)"><span class="nav-icon">üì¢</span><span data-ru="–ó–∞—è–≤–∫–∏" data-en="WTB">–ó–∞—è–≤–∫–∏</span></div>
        <div class="nav-item" onclick="switchTab('profile', this)"><span class="nav-icon">üë§</span><span data-ru="–ü—Ä–æ—Ñ–∏–ª—å" data-en="Profile">–ü—Ä–æ—Ñ–∏–ª—å</span></div>
        <div class="nav-item" onclick="switchTab('info', this)"><span class="nav-icon">‚ÑπÔ∏è</span><span data-ru="–ò–Ω—Ñ–æ" data-en="Info">–ò–Ω—Ñ–æ</span></div>
        <div class="nav-item" id="nav-admin" style="display:none;" onclick="switchTab('admin', this)"><span class="nav-icon">üõ†</span><span data-ru="–ê–¥–º–∏–Ω" data-en="Admin">–ê–¥–º–∏–Ω</span></div>
    </div>

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-step-1">
                <h2 style="margin-top:0; font-size: 22px;" data-ru="–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ!" data-en="Almost done!">–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ!</h2>
                <div style="text-align:left; font-size: 14px; line-height: 1.6; color: #cbd5e1;">
                    <p><span class="step-num">1</span> <span data-ru="–¶–µ–Ω–∞:" data-en="Price:">–¶–µ–Ω–∞:</span> <b id="confirm-price" style="color:white">0</b> TON</p>
                    <p><span class="step-num">2</span> <span data-ru="–ü–µ—Ä–µ–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–∞–Ω–∞–ª–∞" data-en="Transfer channel ownership to">–ü–µ—Ä–µ–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–∞–Ω–∞–ª–∞</span> <b>@<span id="confirm-tag" style="color:white"></span></b> <span data-ru="–∞–∫–∫–∞—É–Ω—Ç—É:" data-en="account:">–∞–∫–∫–∞—É–Ω—Ç—É:</span></p>
                    <div style="background:rgba(0,0,0,0.4); padding:12px; border-radius:12px; text-align:center; font-weight:bold; color:#38bdf8; font-size: 16px; border: 1px dashed #38bdf8;">
                        @TakeMyTag1
                    </div>
                    <p style="font-size:11px; color:var(--text-dim); margin-top:12px;" data-ru="üõ°Ô∏è –Æ–∑–µ—Ä–±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Å—Ç–∞–≤–∏—Ç –ª–æ—Ç." data-en="üõ°Ô∏è The bot will automatically list your item.">üõ°Ô∏è –Æ–∑–µ—Ä–±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Å—Ç–∞–≤–∏—Ç –ª–æ—Ç.</p>
                </div>
                <button class="btn-main" id="dynamic-confirm-btn" style="margin-top: 25px;">–í—ã—Å—Ç–∞–≤–∏—Ç—å –∏ –Ω–∞—á–∞—Ç—å —Ç–∞–π–º–µ—Ä</button>
                <button onclick="closeModal()" style="background:none; border:none; color:var(--text-dim); margin-top:15px; cursor:pointer; font-size: 14px; font-family: 'Montserrat', sans-serif; font-weight: 600; width: 100%;" data-ru="–û—Ç–º–µ–Ω–∞" data-en="Cancel">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div id="modal-step-2" style="display: none;">
                <h2 style="margin-top:0; font-size: 20px;" data-ru="–û–∂–∏–¥–∞–µ–º –ø—Ä–∞–≤–∞..." data-en="Waiting for rights...">–û–∂–∏–¥–∞–µ–º –ø—Ä–∞–≤–∞...</h2>
                <p style="color: var(--text-dim); font-size: 14px;" data-ru="–°–¥–µ–ª–∞–π—Ç–µ <b>@TakeMyTag1</b> –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –∫–∞–Ω–∞–ª–∞." data-en="Make <b>@TakeMyTag1</b> the channel owner.">–°–¥–µ–ª–∞–π—Ç–µ <b>@TakeMyTag1</b> –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –∫–∞–Ω–∞–ª–∞.</p>
                <div class="timer-text" id="countdown">05:00</div>
                <button class="btn-main btn-small" style="background: #475569; margin-top: 15px;" onclick="closeModal()" data-ru="–°–≤–µ—Ä–Ω—É—Ç—å –æ–∫–Ω–æ" data-en="Minimize">–°–≤–µ—Ä–Ω—É—Ç—å –æ–∫–Ω–æ</button>
            </div>
            <div id="modal-step-3" style="display: none;">
                <div style="font-size: 50px; margin-bottom: 10px;">‚úÖ</div>
                <h2 style="margin-top:0; font-size: 22px; color: #10b981;" data-ru="–£—Å–ø–µ—à–Ω–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω!" data-en="Listed Successfully!">–£—Å–ø–µ—à–Ω–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω!</h2>
                <p style="color: var(--text-dim); font-size: 14px; line-height: 1.5;" data-ru="–ë–æ—Ç –ø—Ä–∏—Å–ª–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!" data-en="We sent a notification to the bot!">–ë–æ—Ç –ø—Ä–∏—Å–ª–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!</p>
                <button class="btn-main" style="margin-top: 15px;" onclick="closeModalAndRefresh()" data-ru="–û—Ç–ª–∏—á–Ω–æ" data-en="Great">–û—Ç–ª–∏—á–Ω–æ</button>
            </div>
        </div>
    </div>

    <script>
        const BOT_USERNAME = "TakeMyTag_bot"; 
        const ADMIN_ID = 1308339129; 

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#050505'); 

        const API_URL = "https://rapt-noella-myriadly.ngrok-free.dev/api";
        const headers = { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' };
        const user = tg.initDataUnsafe.user;
        
        let allLots = [];
        let allAuctions = []; 
        let freeVipTickets = 0; 
        let timerInterval, statusInterval;

        let currentLang = 'ru'; 
        const _dict = {
            'buy': {ru: '–ö—É–ø–∏—Ç—å', en: 'Buy'},
            'offer': {ru: 'ü§ù –¢–æ—Ä–≥', en: 'ü§ù Offer'},
            'link': {ru: 'üîó', en: 'üîó'},
            'remove': {ru: '‚ùå –£–±—Ä–∞—Ç—å', en: '‚ùå Remove'},
            'change_price': {ru: '–ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É', en: 'Change Price'},
            'recall': {ru: '–ó–∞–±—Ä–∞—Ç—å', en: 'Recall'},
            'use_ticket': {ru: 'üéü –ö—É–ø–æ–Ω', en: 'üéü Ticket'},
            'boost': {ru: 'üî• –ë—É—Å—Ç–∞–Ω—É—Ç—å (0.5 TON)', en: 'üî• Boost (0.5 TON)'},
            'vip_active': {ru: 'üî• VIP —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–µ–Ω', en: 'üî• VIP Active'},
            'you_get': {ru: '–í—ã –ø–æ–ª—É—á–∏—Ç–µ:', en: 'You will get:'},
            'loading': {ru: '–ó–∞–≥—Ä—É–∑–∫–∞...', en: 'Loading...'},
            'nothing': {ru: '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üòî', en: 'Nothing found üòî'},
            'no_auctions': {ru: '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤', en: 'No active auctions'},
            'no_lots': {ru: '–ù–µ—Ç –ª–æ—Ç–æ–≤ –ø–æ —ç—Ç–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É', en: 'No lots found'},
            'completed': {ru: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ', en: 'Completed'},
            'current_bid': {ru: '–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞:', en: 'Current bid:'},
            'make_bid': {ru: '–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É', en: 'Place Bid'},
            'status_active': {ru: 'üü¢ –ù–∞ –≤–∏—Ç—Ä–∏–Ω–µ', en: 'üü¢ Active'},
            'status_pending': {ru: 'üü° –ñ–¥–µ—Ç –ø—Ä–∞–≤', en: 'üü° Pending'},
            'status_return': {ru: 'üîÑ –í–æ–∑–≤—Ä–∞—â–∞–µ–º...', en: 'üîÑ Returning...'},
            'status_hold': {ru: 'ü§ù –ü—Ä–æ–¥–∞–Ω (–•–æ–ª–¥)', en: 'ü§ù Hold'},
            'status_sold': {ru: '‚úÖ –°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞', en: '‚úÖ Sold'},
            'status_cancel': {ru: '‚ö™ –û—Ç–º–µ–Ω–µ–Ω / –ó–∞–±—Ä–∞–Ω', en: '‚ö™ Cancelled'},
            'hold_after': {ru: '–ü–æ—Å–ª–µ —Ö–æ–ª–¥–∞ (-3.5%):', en: 'After hold (-3.5%):'},
            'success': {ru: '–£—Å–ø–µ—à–Ω–æ!', en: 'Success!'},
            'error': {ru: '–û—à–∏–±–∫–∞', en: 'Error'},
            'connect_wallet': {ru: '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ üí≥', en: 'Connect Wallet üí≥'},
            'connected': {ru: '–ü–æ–¥–∫–ª—é—á–µ–Ω ‚úÖ', en: 'Connected ‚úÖ'},
            'cancel': {ru: '–û—Ç–º–µ–Ω–∞', en: 'Cancel'},
            'ok': {ru: '–ó–∞–∫—Ä—ã—Ç—å', en: 'Close'},
            'radar_btn': {ru: 'üì° –£–º–Ω—ã–π –†–∞–¥–∞—Ä', en: 'üì° Smart Radar'}
        };
        function _t(key) { return _dict[key] ? _dict[key][currentLang] : key; }

        function updateStaticTexts() {
            document.querySelectorAll('[data-ru]').forEach(el => {
                const text = currentLang === 'en' && el.getAttribute('data-en') ? el.getAttribute('data-en') : el.getAttribute('data-ru');
                if (el.tagName === 'INPUT' && (el.type === 'text' || el.type === 'number')) el.placeholder = text;
                else if (el.tagName === 'OPTION') el.innerText = text;
                else el.innerHTML = text;
            });
            document.getElementById('wallet-status').innerText = tonConnectUI.connected ? _t('connected') : _t('connect_wallet');
        }

        function selectLanguage(lang) {
            currentLang = lang;
            updateStaticTexts();
            const loader = document.getElementById('loader');
            loader.style.display = 'flex';
            loader.style.opacity = '1';

            document.getElementById('lang-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('lang-screen').style.display = 'none';
                startAppLoader(); 
            }, 500);
        }

        function startAppLoader() {
            let percent = 0;
            const percentEl = document.getElementById("loader-percent");
            const barEl = document.getElementById("loader-bar");
            const loader = document.getElementById('loader');
            
            const interval = setInterval(() => {
                percent += 1; 
                if (percent >= 100) percent = 100;
                percentEl.innerText = percent; 
                barEl.style.width = percent + "%";
                if (percent === 100) { 
                    clearInterval(interval); 
                    setTimeout(() => { 
                        loader.style.opacity = "0"; 
                        setTimeout(() => loader.style.display = "none", 500); 
                    }, 300); 
                }
            }, 30);

            if (user) { 
                fetchUserData(); 
                fetchLots(); 
                fetchAuctions(); 
                fetchWTB(); // –ì—Ä—É–∑–∏–º –∑–∞—è–≤–∫–∏ WTB
                if (user.id === ADMIN_ID) {
                    document.getElementById('nav-admin').style.display = 'block';
                    loadAdminStats();
                    loadAdminWithdrawals();
                }
            }
        }

        const svgCheckmark = `<svg style="width:16px; height:16px; margin-left:4px; margin-right:4px; vertical-align:text-bottom; filter: drop-shadow(0 0 4px rgba(139, 92, 246, 0.6)); flex-shrink: 0;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 0L14.59 3.53L18.96 4.2L19.78 8.44L23.09 11.1L20.85 14.88L22.5 19.04L18.42 20.3L16.29 24L12 22.36L7.71 24L5.58 20.3L1.5 19.04L3.15 14.88L0.91 11.1L4.22 8.44L5.04 4.2L9.41 3.53L12 0Z" fill="var(--premium-color)"/><path d="M10.2 16.2L6 12L7.4 10.6L10.2 13.4L16.6 7L18 8.4L10.2 16.2Z" fill="white"/></svg>`;

        function renderSkeletons(containerId, count=3) {
            const container = document.getElementById(containerId);
            let html = '';
            for(let i=0; i<count; i++) {
                html += `<div class="lot-item glass-card" style="flex-direction: column; gap: 12px; border-color: transparent;"><div style="display: flex; justify-content: space-between; width: 100%;"><div class="skeleton" style="width: 45%; height: 20px;"></div></div><div style="display: flex; justify-content: space-between; width: 100%; align-items: center; margin-top: 5px;"><div class="skeleton" style="width: 25%; height: 20px;"></div><div class="skeleton" style="width: 35%; height: 36px; border-radius: 12px;"></div></div></div>`;
            }
            container.innerHTML = html;
        }

        renderSkeletons('lots-container', 4);
        renderSkeletons('profile-list', 2);
        renderSkeletons('auctions-container', 2);
        renderSkeletons('wtb-container', 2);

        document.getElementById('price-input').addEventListener('input', function() {
            const val = parseFloat(this.value);
            const hint = document.getElementById('price-calc-hint');
            if (!isNaN(val) && val > 0) {
                hint.innerHTML = `${_t('you_get')} ${(val * 0.965).toFixed(2)} TON <span style="color:var(--text-dim);font-size:11px;">(-3.5%)</span>`;
                hint.style.display = 'block';
            } else { hint.style.display = 'none'; }
        });

        window.updateModalPriceHint = function(val) {
            const num = parseFloat(val);
            const hint = document.getElementById('modal-price-calc-hint');
            if(!isNaN(num) && num > 0) {
                hint.innerHTML = `${_t('you_get')} ${(num * 0.965).toFixed(2)} TON <span style="color:var(--text-dim);font-size:11px;">(-3.5%)</span>`;
                hint.style.display = 'block';
            } else { hint.style.display = 'none'; }
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `custom-toast ${type}`;
            toast.innerHTML = message.replace(/\n/g, '<br>');
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('fade-out'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function showActionModal(html) { document.getElementById('action-modal-body').innerHTML = html; document.getElementById('action-modal').style.display = 'flex'; }
        function closeActionModal() { document.getElementById('action-modal').style.display = 'none'; }

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: 'https://takemytag.vercel.app/tonconnect-manifest.json', buttonRootId: 'ton-connect-button' });
        tonConnectUI.onStatusChange(wallet => {
            document.getElementById('wallet-status').innerText = wallet ? _t('connected') : _t('connect_wallet');
            document.getElementById('wallet-status').style.color = wallet ? "var(--success)" : "var(--text-main)";
        });

        // üí° –ì–õ–û–ë–ê–õ–¨–ù–´–ô –û–ë–™–ï–ö–¢ –Æ–ó–ï–†–ê (–î–õ–Ø –†–ê–î–ê–†–ê)
        let currentUserData = null;

        async function fetchUserData() {
            if (!user) return;
            const startParam = tg.initDataUnsafe?.start_param || "";
            let refId = null;
            if (startParam.startsWith('ref_')) refId = startParam.replace('ref_', '');
            try {
                const res = await fetch(refId ? `${API_URL}/users/${user.id}?ref_id=${refId}` : `${API_URL}/users/${user.id}`, { headers });
                const data = await res.json();
                currentUserData = data; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —Ä–∞–¥–∞—Ä–∞
                
                const verifiedIcon = data.is_verified ? svgCheckmark : '';
                document.getElementById('profile-name').innerHTML = `–ü—Ä–∏–≤–µ—Ç, ${user.first_name}! ${verifiedIcon}`;
                document.getElementById('avail-balance').innerText = `${data.available_balance.toFixed(2)} TON`;
                document.getElementById('froz-balance').innerText = `${data.frozen_balance.toFixed(2)} TON`;
                if(document.getElementById('ref-earnings')) document.getElementById('ref-earnings').innerText = `${(data.ref_earnings || 0).toFixed(2)} TON`;

                // üí° –û–¢–†–ò–°–û–í–ö–ê –ë–ï–ô–î–ñ–ê –õ–û–Ø–õ–¨–ù–û–°–¢–ò
                const loyaltyBadge = document.getElementById('loyalty-badge');
                if (data.loyalty_level === "–ë—Ä–æ–Ω–∑–∞") { loyaltyBadge.className = "loyalty-badge bronze"; }
                else if (data.loyalty_level === "–°–µ—Ä–µ–±—Ä–æ") { loyaltyBadge.className = "loyalty-badge silver"; }
                else { loyaltyBadge.className = "loyalty-badge gold"; }
                
                let lvlText = data.loyalty_level;
                if (currentLang === 'en') {
                    if(lvlText==="–ë—Ä–æ–Ω–∑–∞") lvlText="Bronze";
                    if(lvlText==="–°–µ—Ä–µ–±—Ä–æ") lvlText="Silver";
                    if(lvlText==="–ó–æ–ª–æ—Ç–æ") lvlText="Gold";
                }
                loyaltyBadge.innerText = `${lvlText} (${data.loyalty_percent}%)`;
                loyaltyBadge.style.display = 'inline-block';

                freeVipTickets = data.free_vip_tickets || 0;
                const ticketsDisplay = document.getElementById('vip-tickets-display');
                if (freeVipTickets > 0) {
                    ticketsDisplay.innerText = currentLang === 'ru' ? `üéü –£ –≤–∞—Å –µ—Å—Ç—å ${freeVipTickets} –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫—É–ø–æ–Ω–æ–≤ –Ω–∞ VIP-–±—É—Å—Ç!` : `üéü You have ${freeVipTickets} free VIP tickets!`;
                    ticketsDisplay.style.display = 'block';
                } else { ticketsDisplay.style.display = 'none'; }
                
                // –ö–Ω–æ–ø–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º
                document.getElementById('ref-btn').innerText = currentLang === 'ru' ? `üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞ (${data.loyalty_percent}%)` : `üîó Invite Friend (${data.loyalty_percent}%)`;
                
            } catch (e) { }
        }

        async function fetchLots() {
            try {
                const url = user ? `${API_URL}/lots?user_id=${user.id}` : `${API_URL}/lots`;
                const res = await fetch(url, { headers });
                allLots = await res.json();
                renderMarket();
                checkStartParam(); 
            } catch (e) { }
        }

        async function fetchAuctions() {
            try {
                const res = await fetch(`${API_URL}/auctions`, { headers });
                allAuctions = await res.json();
                renderAuctions();
            } catch (e) { }
        }

        // üí° –ù–û–í–û–ï: –ó–ê–ì–†–£–ó–ö–ê –ë–ò–†–ñ–ò WTB
        async function fetchWTB() {
            try {
                const res = await fetch(`${API_URL}/wtb`, { headers });
                const wtbs = await res.json();
                const container = document.getElementById('wtb-container');
                if(wtbs.length === 0) {
                    container.innerHTML = `<div style="text-align:center;color:var(--text-dim);margin-top:20px;">${_t('nothing')}</div>`;
                    return;
                }
                container.innerHTML = wtbs.map(w => {
                    const verifiedBadge = w.is_verified ? svgCheckmark : '';
                    let btnStr = currentLang === 'en' ? 'Offer tag' : '–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–µ–≥';
                    return `
                    <div class="lot-item glass-card" style="flex-direction: column; align-items: stretch; gap: 10px;">
                        <div style="font-size:14px; color: white; line-height: 1.5;">${w.description}</div>
                        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                            <div><div style="font-size:11px; color:var(--text-dim);">–ë—é–¥–∂–µ—Ç:</div><div style="color:var(--success); font-weight:800; font-size:16px;">${w.budget} TON</div></div>
                            <div style="font-size:11px; color:var(--text-dim);">–û—Ç: ID${w.buyer_id} ${verifiedBadge}</div>
                            <button class="buy-btn" style="background:#8b5cf6;" onclick="openWTBOfferModal(${w.id}, ${w.budget})">${btnStr}</button>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) { }
        }

        async function submitWTB() {
            const desc = document.getElementById('wtb-desc-input').value.trim();
            const budget = parseFloat(document.getElementById('wtb-budget-input').value);
            if (!desc || isNaN(budget) || budget <= 0) return showNotification(_t('error'), "error");
            
            showActionModal(`<h3>${_t('loading')}</h3>`);
            try {
                const res = await fetch(`${API_URL}/wtb`, { 
                    method: 'POST', headers, 
                    body: JSON.stringify({ buyer_id: user.id, description: desc, budget: budget }) 
                });
                if (res.ok) { 
                    showNotification(_t('success'), "success"); 
                    closeActionModal(); 
                    document.getElementById('wtb-desc-input').value = '';
                    document.getElementById('wtb-budget-input').value = '';
                    fetchWTB();
                } else { showNotification(_t('error'), "error"); closeActionModal(); }
            } catch (e) { showNotification(_t('error'), "error"); closeActionModal(); }
        }

        function openWTBOfferModal(wtbId, maxBudget) {
            let titleStr = currentLang === 'en' ? 'Offer a Tag' : '–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–µ–≥';
            let tagStr = currentLang === 'en' ? 'Tag name (without @)' : '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞ (–±–µ–∑ @)';
            let priceStr = currentLang === 'en' ? 'Price (TON)' : '–¶–µ–Ω–∞ (TON)';
            let btnStr = currentLang === 'en' ? 'Send Offer' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ';

            showActionModal(`
                <h3 style="margin-top:0; color:#8b5cf6;">${titleStr}</h3>
                <p style="font-size:12px; color:var(--text-dim); margin-bottom: 15px;">–ë—é–¥–∂–µ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è: –¥–æ <b>${maxBudget} TON</b></p>
                <input type="text" id="wtb-offer-tag" placeholder="${tagStr}">
                <input type="number" id="wtb-offer-price" placeholder="${priceStr}">
                <div class="flex-btns">
                    <button class="btn-cancel" onclick="closeActionModal()">${_t('cancel')}</button>
                    <button class="btn-confirm" style="background:#8b5cf6;" onclick="submitWTBOffer(${wtbId})">${btnStr}</button>
                </div>
            `);
        }

        async function submitWTBOffer(wtbId) {
            const tag = document.getElementById('wtb-offer-tag').value.trim().replace('@', '');
            const price = parseFloat(document.getElementById('wtb-offer-price').value);

            if (!tag || isNaN(price) || price <= 0) return showNotification(_t('error'), "error");

            showActionModal(`<h3>${_t('loading')}</h3>`);
            try {
                const res = await fetch(`${API_URL}/wtb/${wtbId}/offer`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        seller_id: user.id,
                        tag: tag,
                        price: price
                    })
                });
                
                if (res.ok) {
                    showNotification("‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!", "success");
                    closeActionModal();
                } else {
                    showNotification(_t('error'), "error");
                    closeActionModal();
                }
            } catch (e) {
                showNotification(_t('error'), "error");
                closeActionModal();
            }
        }

        // üí° –ù–û–í–û–ï: –õ–û–ì–ò–ö–ê –†–ê–î–ê–†–ê
        async function openRadarMenu() {
            if (!currentUserData) return;
            let titleStr = currentLang === 'en' ? `üì° Smart Radar` : `üì° –£–º–Ω—ã–π –†–∞–¥–∞—Ä`;
            
            if (!currentUserData.has_radar) {
                let descStr = currentLang === 'en' ? `Get instant notifications when a tag matching your criteria appears! Price: 1.5 TON.` : `–ë–æ—Ç –ø—Ä–∏—à–ª–µ—Ç –≤–∞–º –ø—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –Ω–∞ –º–∞—Ä–∫–µ—Ç–µ –ø–æ—è–≤–∏—Ç—Å—è —Ç–µ–≥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –∏—â–µ—Ç–µ!<br><br>–°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞: <b>1.5 TON</b>`;
                let btnStr = currentLang === 'en' ? `Buy Radar` : `–ö—É–ø–∏—Ç—å –†–∞–¥–∞—Ä`;
                showActionModal(`
                    <h3 style="margin-top:0; color:#ec4899;">${titleStr}</h3>
                    <p style="font-size:13px; color:var(--text-dim); line-height: 1.5; margin-bottom:20px;">${descStr}</p>
                    <div class="flex-btns">
                        <button class="btn-cancel" onclick="closeActionModal()">${_t('cancel')}</button>
                        <button class="btn-confirm" style="background:linear-gradient(135deg, #ec4899, #f43f5e);" onclick="buyRadar()">${btnStr}</button>
                    </div>
                `);
            } else {
                showActionModal(`<h3>${_t('loading')}</h3>`);
                try {
                    const res = await fetch(`${API_URL}/users/${user.id}/radar`, {headers});
                    const cfg = await res.json();
                    let saveStr = currentLang === 'en' ? `Save Config` : `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã`;
                    let descStr = currentLang === 'en' ? `Leave empty if you don't care.` : `–û—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª—è –ø—É—Å—Ç—ã–º–∏, –µ—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ –≤–∞–∂–µ–Ω.`;
                    
                    showActionModal(`
                        <h3 style="margin-top:0; color:#ec4899;">${titleStr}</h3>
                        <p style="font-size:12px; color:var(--text-dim);">${descStr}</p>
                        <input type="number" id="radar-price" placeholder="–ú–∞–∫—Å. —Ü–µ–Ω–∞ (TON)" value="${cfg.max_price || ''}">
                        <input type="number" id="radar-len" placeholder="–ú–∞–∫—Å. –¥–ª–∏–Ω–∞ (–±—É–∫–≤)" value="${cfg.max_length || ''}">
                        <input type="text" id="radar-word" placeholder="–°–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, crypto)" value="${cfg.keyword || ''}">
                        <div class="flex-btns">
                            <button class="btn-cancel" onclick="closeActionModal()">${_t('cancel')}</button>
                            <button class="btn-confirm" style="background:linear-gradient(135deg, #ec4899, #f43f5e);" onclick="saveRadarConfig()">${saveStr}</button>
                        </div>
                    `);
                } catch(e) { closeActionModal(); }
            }
        }

        async function buyRadar() {
            closeActionModal();
            try {
                const res = await fetch(`${API_URL}/users/${user.id}/radar/buy`, { method: 'POST', headers });
                if (res.ok) { showNotification(_t('success'), "success"); fetchUserData(); openRadarMenu(); } 
                else { showNotification(_t('error'), "error"); }
            } catch(e) { showNotification(_t('error'), "error"); }
        }

        async function saveRadarConfig() {
            let price = parseFloat(document.getElementById('radar-price').value);
            let length = parseInt(document.getElementById('radar-len').value);
            let keyword = document.getElementById('radar-word').value.trim();
            
            closeActionModal();
            try {
                const res = await fetch(`${API_URL}/users/${user.id}/radar/config`, { 
                    method: 'POST', headers, 
                    body: JSON.stringify({ 
                        user_id: user.id, 
                        max_price: isNaN(price) ? null : price, 
                        max_length: isNaN(length) ? null : length, 
                        keyword: keyword || null 
                    }) 
                });
                if (res.ok) { showNotification(_t('success'), "success"); } 
                else { showNotification(_t('error'), "error"); }
            } catch(e) { showNotification(_t('error'), "error"); }
        }


        async function toggleFavorite(lotId) {
            if (!user) return showNotification(currentLang === 'en' ? "Login required!" : "–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!", "error");
            try {
                const res = await fetch(`${API_URL}/lots/${lotId}/favorite`, { method: 'POST', headers, body: JSON.stringify({ user_id: user.id }) });
                if (res.ok) { fetchLots(); if(document.getElementById('tab-profile').classList.contains('active')) renderProfile(); }
            } catch(e) {}
        }

        async function openLeaderboardModal() {
            showActionModal(`<h3>${_t('loading')}</h3>`);
            try {
                const res = await fetch(`${API_URL}/leaderboard`, { headers });
                const top = await res.json();
                let titleStr = currentLang === 'en' ? 'üèÜ Top Sellers' : 'üèÜ –¢–æ–ø –ø—Ä–æ–¥–∞–≤—Ü–æ–≤';
                let emptyStr = currentLang === 'en' ? 'Nobody has sold anything yet.' : '–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–¥–∞–ª.';
                let salesStr = currentLang === 'en' ? 'Sales:' : '–°–¥–µ–ª–æ–∫:';
                
                if (top.length === 0) return showActionModal(`<h3 style="margin-top:0;">${titleStr}</h3><p style="color:var(--text-dim);">${emptyStr}</p><button class="btn-main" onclick="closeActionModal()">${_t('ok')}</button>`);
                const html = top.map((t, index) => {
                    let rank = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `<b style="color:var(--text-dim)">${index + 1}.</b>`;
                    return `<div style="background:rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05); padding:12px 16px; border-radius:16px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div style="display:flex; align-items:center; gap:12px;"><div style="font-size:22px; width:25px; text-align:center;">${rank}</div><div style="font-weight:700; font-size:15px; word-break: break-all;">${t.username}</div></div><div style="text-align:right;"><div style="color:var(--accent-color); font-weight:800; font-size:16px;">${t.total_tons} TON</div><div style="color:var(--text-dim); font-size:11px; text-transform:uppercase; margin-top:2px;">${salesStr} ${t.sales_count}</div></div></div>`;
                }).join('');
                showActionModal(`<h3 style="margin-top:0; margin-bottom:20px; font-size:20px;">${titleStr}</h3><div class="history-container" style="max-height:55vh; overflow-y:auto; padding-right:5px; margin-bottom:15px; text-align:left;">${html}</div><button class="btn-main" onclick="closeActionModal()">${_t('ok')}</button>`);
            } catch(e) { showNotification(_t('error'), "error"); closeActionModal(); }
        }

        function formatTime(seconds) {
            if (seconds <= 0) return _t('completed');
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function renderAuctions() {
            const container = document.getElementById('auctions-container');
            if (allAuctions.length === 0) { container.innerHTML = `<div style="text-align:center;color:var(--text-dim);margin-top:20px;">${_t('no_auctions')}</div>`; return; }
            container.innerHTML = allAuctions.map(a => `
                <div class="lot-item glass-card" style="flex-direction: column; align-items: stretch; gap: 10px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; width: 100%;">
                        <div style="font-weight:700; font-size:18px; word-break: break-all; margin-right: 10px;">@${a.target_username}</div>
                        <div style="color:#ef4444; background: rgba(239, 68, 68, 0.1); padding: 4px 8px; border-radius: 8px; font-weight:800; font-size:13px; font-family: monospace; flex-shrink: 0;" id="timer-auc-${a.id}">${formatTime(a.time_left)}</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                        <div><div style="font-size:12px; color:var(--text-dim);">${_t('current_bid')}</div><div style="color:var(--accent-color); font-weight:800; font-size:16px;">${a.current_price} TON</div></div>
                        <button class="buy-btn" style="background:#f59e0b;" onclick="openBidModal(${a.id}, '${a.target_username}', ${a.current_price})">${_t('make_bid')}</button>
                    </div>
                </div>
            `).join('');
        }

        setInterval(() => {
            allAuctions.forEach(a => {
                if (a.time_left > 0) {
                    a.time_left--;
                    const timerEl = document.getElementById(`timer-auc-${a.id}`);
                    if (timerEl) timerEl.innerText = formatTime(a.time_left);
                } else if (a.time_left === 0) {
                    a.time_left = -1;
                    const timerEl = document.getElementById(`timer-auc-${a.id}`);
                    if (timerEl) timerEl.innerText = _t('completed');
                }
            });
        }, 1000);

        function openBidModal(aucId, tag, currentPrice) {
            const minBid = (currentPrice * 1.05).toFixed(2);
            let titleStr = currentLang === 'en' ? `Bid on @${tag}` : `–°—Ç–∞–≤–∫–∞ –Ω–∞ @${tag}`;
            let hintStr = currentLang === 'en' ? `Deducted from balance. If outbid, returned instantly.` : `–°–ø–∏—à–µ—Ç—Å—è —Å –±–∞–ª–∞–Ω—Å–∞. –ï—Å–ª–∏ –µ—ë –ø–µ—Ä–µ–±—å—é—Ç ‚Äî –¥–µ–Ω—å–≥–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–µ—Ä–Ω—É—Ç—Å—è.`;
            showActionModal(`
                <h3 style="margin-top:0;">${titleStr}</h3>
                <p style="font-size:13px; color:var(--text-dim);">${_t('current_bid')} <b>${currentPrice} TON</b></p>
                <input type="number" id="bid-input" placeholder="Min. ${minBid} TON">
                <div class="flex-btns">
                    <button class="btn-cancel" onclick="closeActionModal()">${_t('cancel')}</button>
                    <button class="btn-confirm" onclick="submitBid(${aucId}, ${currentPrice})">${_t('make_bid')}</button>
                </div>
                <p style="font-size:11px; color:var(--warning); margin-top:10px;">${hintStr}</p>
            `);
        }

        async function submitBid(aucId, currentPrice) {
            const amount = parseFloat(document.getElementById('bid-input').value);
            if (isNaN(amount) || amount <= currentPrice) return showNotification(_t('error'), "error");
            showActionModal(`<h3>${_t('loading')}</h3>`);
            try {
                const res = await fetch(`${API_URL}/auctions/${aucId}/bid`, { method: 'POST', headers, body: JSON.stringify({ user_id: user.id, amount: amount }) });
                if (res.ok) { showNotification(_t('success'), "success"); closeActionModal(); fetchAuctions(); fetchUserData(); 
                } else { showNotification(_t('error'), "error"); closeActionModal(); }
            } catch (e) { showNotification(_t('error'), "error"); closeActionModal(); }
        }

        function copyRefLink() {
            const shareUrl = `https://t.me/${BOT_USERNAME}/app?startapp=ref_${user.id}`;
            const text = `üî• TakeMyTag Market!`;
            const tgShareLink = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(text)}`;
            tg.openTelegramLink(tgShareLink);
        }

        async function openPreviewModal(lotId, tag, price) {
            fetch(`${API_URL}/lots/${lotId}/view`, { method: 'POST', headers }); 
            showActionModal(`<h3>${_t('loading')}</h3>`);
            
            try {
                const res = await fetch(`${API_URL}/lots/${lotId}/details`, { headers });
                const data = await res.json();
                
                let title = currentLang === 'en' ? 'Purchase Username' : '–î–µ—Ç–∞–ª–∏ —é–∑–µ—Ä–Ω–µ–π–º–∞';
                let status = currentLang === 'en' ? 'Ready to transfer' : '–ì–æ—Ç–æ–≤ –∫ –ø–µ—Ä–µ–¥–∞—á–µ';
                let guarantor = currentLang === 'en' ? 'Bot TakeMyTag' : '–ë–æ—Ç TakeMyTag';
                let time = currentLang === 'en' ? 'Instant' : '–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ';
                let btn = currentLang === 'en' ? 'Proceed to Payment' : '–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ';
                
                let fomoHtml = '';
                if (data.favorites_count > 0) {
                    let fomoText = currentLang === 'en' 
                        ? `‚ù§Ô∏è Favorited by <b>${data.favorites_count}</b> people (Hurry up!)` 
                        : `‚ù§Ô∏è –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º —É <b>${data.favorites_count}</b> —á–µ–ª. (–£—Å–ø–µ–π –∑–∞–±—Ä–∞—Ç—å!)`;
                    fomoHtml = `<div style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); color: #fca5a5; padding: 10px; border-radius: 12px; font-size: 12px; margin-bottom: 15px; font-weight: 600; animation: fomoPulse 2s infinite;">${fomoText}</div>`;
                }

                showActionModal(`
                    <div style="text-align: center;">
                        <div style="font-size: 45px; margin-bottom: 5px;">üíé</div>
                        <h3 style="margin-top:0; color: var(--text-dim); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">${title}</h3>
                        <div style="background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 20px; border-radius: 20px; margin-bottom: 15px;">
                            <h2 style="margin:0 0 5px 0; font-size: 26px; color: white; word-break: break-all;">@${tag}</h2>
                            <div style="font-size: 24px; font-weight: 800; color: var(--accent-color);">${price} TON</div>
                        </div>
                        ${fomoHtml}
                        <div style="text-align: left; background: rgba(0,0,0,0.4); padding: 15px; border-radius: 16px; margin-bottom: 20px; font-size: 13px; color: #cbd5e1; line-height: 1.8;">
                            <div style="display:flex; justify-content:space-between; margin-bottom: 4px;"><span>‚úÖ <b>Status:</b></span> <span style="color:var(--success); font-weight:bold;">${status}</span></div>
                            <div style="display:flex; justify-content:space-between; margin-bottom: 4px;"><span>üõ° <b>Guarantor:</b></span> <span>${guarantor}</span></div>
                            <div style="display:flex; justify-content:space-between; margin-bottom: 4px;"><span>‚è± <b>Transfer:</b></span> <span>${time}</span></div>
                            <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 8px 0;"></div>
                            <div style="display:flex; justify-content:space-between;"><span>üëÅ <b>Views:</b></span> <span>${data.views || 0}</span></div>
                        </div>
                        <div class="flex-btns" style="flex-direction: column; gap: 10px;">
                            <button class="btn-main" style="padding: 16px; font-size: 16px;" onclick="openBuyModal(${lotId}, ${price}, '${tag}')">${btn}</button>
                            <button class="btn-cancel" onclick="closeActionModal()">${_t('cancel')}</button>
                        </div>
                    </div>
                `);
            } catch (e) {
                showNotification(_t('error'), "error");
                closeActionModal();
            }
        }

        let startParamProcessed = false;
        function checkStartParam() {
            if (startParamProcessed) return;
            const startParam = tg.initDataUnsafe?.start_param;
            if (startParam && startParam.startsWith('lot_')) {
                const targetLotId = parseInt(startParam.replace('lot_', ''));
                const targetLot = allLots.find(l => l.id === targetLotId);
                if (targetLot) { openPreviewModal(targetLot.id, targetLot.target_username, targetLot.price); startParamProcessed = true; }
            }
            // üí° –ù–û–í–û–ï: –ï–°–õ–ò –≠–¢–û P2P –°–î–ï–õ–ö–ê
            if (startParam && startParam.startsWith('p2p_')) {
                const targetLotId = parseInt(startParam.replace('p2p_', ''));
                fetch(`${API_URL}/lots/${targetLotId}/details`, { headers })
                .then(res => res.json())
                .then(data => { openPreviewModal(data.id, data.target_username, data.price); startParamProcessed = true; })
                .catch(e => {});
            }
        }

        function shareLot(lotId, tag, price) {
            const shareUrl = `https://t.me/${BOT_USERNAME}/app?startapp=lot_${lotId}`;
            const text = `üî• @${tag} - ${price} TON`;
            const tgShareLink = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(text)}`;
            tg.openTelegramLink(tgShareLink);
        }

        function renderMarket() {
            const filter = document.getElementById('filter-select').value;
            const searchQuery = document.getElementById('search-input').value.toLowerCase().replace('@', ''); 
            
            let sorted = [...allLots];
            if (searchQuery) sorted = sorted.filter(lot => lot.target_username.toLowerCase().includes(searchQuery));
            if(filter === 'price_asc') sorted.sort((a,b) => a.price - b.price);
            if(filter === 'price_desc') sorted.sort((a,b) => b.price - a.price);
            if(filter === 'len_asc') sorted.sort((a,b) => a.target_username.length - b.target_username.length);
            if(filter === 'len_desc') sorted.sort((a,b) => b.target_username.length - a.target_username.length);

            sorted.sort((a, b) => (b.is_vip ? 1 : 0) - (a.is_vip ? 1 : 0));

            const container = document.getElementById('lots-container');
            if (sorted.length === 0) { container.innerHTML = `<div style="text-align:center;color:var(--text-dim);margin-top:20px;">${_t('nothing')}</div>`; return; }

            container.innerHTML = sorted.map(lot => {
                const vipClass = lot.is_vip ? 'vip-lot' : '';
                const vipBadge = lot.is_vip ? '<span class="vip-badge">üî• VIP</span>' : '';
                const verifiedBadge = lot.seller_is_verified ? svgCheckmark : '';
                const favIcon = lot.is_favorite ? '‚ù§Ô∏è' : 'ü§ç';

                return `
                <div class="lot-item glass-card ${vipClass}" style="flex-direction: column; align-items: stretch; gap: 14px;">
                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 6px;">
                        <span style="font-weight:700; font-size:16px; word-break: break-all;">@${lot.target_username}</span>
                        <div style="display: flex; align-items: center; flex-shrink: 0;">${verifiedBadge}${vipBadge}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; width: 100%;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <div style="color:var(--accent-color); font-weight:700; font-size:16px;">${lot.price} TON</div>
                            <div style="color:var(--text-dim); font-size:12px; background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 8px;">üëÅ ${lot.views || 0}</div>
                        </div>
                        <div style="display:flex; justify-content: flex-end; flex-wrap: wrap; gap:8px; flex-shrink: 0;">
                            <button class="buy-btn" style="background:rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 8px 10px; font-size: 14px;" onclick="toggleFavorite(${lot.id})">${favIcon}</button>
                            <button class="buy-btn" style="background:rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 8px 12px;" onclick="shareLot(${lot.id}, '${lot.target_username}', ${lot.price})">${_t('link')}</button>
                            <button class="buy-btn" style="background:rgba(245, 158, 11, 0.2); color: var(--warning); padding: 8px 12px;" onclick="openOfferModal(${lot.id}, '${lot.target_username}', ${lot.price})">${_t('offer')}</button>
                            <button class="buy-btn" style="padding: 8px 20px;" onclick="openPreviewModal(${lot.id}, '${lot.target_username}', ${lot.price})">${_t('buy')}</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function renderProfile() {
            if(!user) return;
            try {
                const filter = document.getElementById('profile-filter-select').value;
                const url = filter === 'favorites' ? `${API_URL}/users/${user.id}/favorites` : `${API_URL}/users/${user.id}/lots`;
                
                const res = await fetch(url, {headers});
                let myLots = await res.json();
                
                if (filter === 'active') myLots = myLots.filter(l => l.status === 'active' || l.status === 'pending_holder');
                if (filter === 'sold') myLots = myLots.filter(l => l.status === 'sold' || l.status === 'locked' || l.status === 'completed');
                if (filter === 'closed') myLots = myLots.filter(l => l.status === 'closed' || l.status === 'pending_return');
                if (filter !== 'favorites') { if (filter === 'old') myLots.sort((a,b) => a.id - b.id); else myLots.sort((a,b) => b.id - a.id); }

                const container = document.getElementById('profile-list');
                if(myLots.length === 0) { container.innerHTML = `<div style="text-align:center;color:var(--text-dim);margin-top:20px;">${_t('no_lots')}</div>`; return; }

                container.innerHTML = myLots.map(lot => {
                    let statusText = ''; let statusColor = 'var(--text-dim)'; let statusBg = 'transparent';
                    
                    if (lot.status === 'active') { statusText = _t('status_active'); statusColor = 'var(--success)'; statusBg = 'rgba(16,185,129,0.1)'; }
                    else if (lot.status === 'pending_holder') { statusText = _t('status_pending'); statusColor = 'var(--warning)'; statusBg = 'rgba(245,158,11,0.1)'; }
                    else if (lot.status === 'pending_return') { statusText = _t('status_return'); }
                    else if (lot.status === 'sold' || lot.status === 'locked') { statusText = _t('status_hold'); statusColor = '#38bdf8'; statusBg = 'rgba(56,189,248,0.1)'; }
                    else if (lot.status === 'completed') { statusText = _t('status_sold'); statusColor = 'var(--success)'; statusBg = 'rgba(16,185,129,0.1)';}
                    else if (lot.status === 'closed') { statusText = _t('status_cancel'); }
                    else { statusText = '‚ö™ ' + lot.status; }
                    
                    let actionButtons = ''; let holdText = '';

                    if (lot.seller_id === user.id) {
                        holdText = `<br>${_t('hold_after')} <b style="color:var(--warning);">${(lot.price * 0.965).toFixed(2)} TON</b>`;
                        
                        // üí° –ï–°–õ–ò –õ–û–¢ –ü–†–ò–í–ê–¢–ù–´–ô, –í–´–í–û–î–ò–ú –°–°–´–õ–ö–£ –î–õ–Ø P2P
                        if (lot.is_private) {
                            holdText += `<br><span style="color:#8b5cf6; font-size:11px;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –ø–æ–∫—É–ø–∞—Ç–µ–ª—é:</span><br><code style="font-size:10px; background:rgba(255,255,255,0.1); padding:2px 4px; border-radius:4px; user-select:all;">https://t.me/${BOT_USERNAME}/app?startapp=p2p_${lot.id}</code>`;
                        }
                        
                        if (lot.status === 'active' || lot.status === 'pending_holder') {
                            let vipBtnText = freeVipTickets > 0 ? `${_t('use_ticket')} (${freeVipTickets})` : _t('boost');
                            let vipButton = lot.is_vip 
                                ? `<div style="color:#fbbf24; font-size:12px; font-weight:bold; margin-top:12px; text-align:center; background:rgba(251,191,36,0.1); padding:8px; border-radius:10px;">${_t('vip_active')}</div>`
                                : `<button class="btn-main btn-small" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; flex:1; margin-top: 12px;" onclick="openVipModal(${lot.id}, '${lot.target_username}')">${vipBtnText}</button>`;

                            actionButtons = `
                                <div style="display:flex; gap:10px; margin-top:15px; flex-wrap: wrap;">
                                    <button class="btn-main btn-small" style="background:rgba(255,255,255,0.1); border:1px solid var(--glass-border); flex:1; min-width: 120px;" onclick="openPriceModal(${lot.id}, '${lot.target_username}')">${_t('change_price')}</button>
                                    ${lot.status === 'active' ? `<button class="btn-main btn-small" style="background:rgba(239, 68, 68, 0.2); color: var(--error); flex:1; min-width: 120px;" onclick="openRecallModal(${lot.id}, '${lot.target_username}')">${_t('recall')}</button>` : ''}
                                </div>
                                ${lot.is_private ? '' : vipButton} `;
                        }
                    } else {
                        actionButtons = `
                            <div style="display:flex; justify-content:flex-end; gap:8px; margin-top: 15px; flex-wrap:wrap;">
                                <button class="buy-btn" style="background:rgba(255,255,255,0.1); border: 1px solid var(--glass-border); padding: 8px 12px; flex:1;" onclick="toggleFavorite(${lot.id})">${_t('remove')}</button>
                                <button class="buy-btn" style="background:rgba(245, 158, 11, 0.2); color: var(--warning); padding: 8px 12px; flex:1;" onclick="openOfferModal(${lot.id}, '${lot.target_username}', ${lot.price})">${_t('offer')}</button>
                                <button class="buy-btn" style="padding: 8px 16px; flex:2;" onclick="openPreviewModal(${lot.id}, '${lot.target_username}', ${lot.price})">${_t('buy')}</button>
                            </div>
                        `;
                    }

                    const verifiedBadge = lot.seller_is_verified ? svgCheckmark : '';
                    const vipBadge = lot.is_vip ? '<span class="vip-badge" style="margin-left:4px;">üî• VIP</span>' : '';
                    const privateBadge = lot.is_private ? '<span style="background:rgba(139, 92, 246, 0.2); color:#8b5cf6; font-size:10px; font-weight:bold; padding:2px 6px; border-radius:4px; margin-left:4px;">P2P</span>' : '';

                    return `
                    <div class="input-box glass-card" style="padding:16px; position:relative; overflow:hidden;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; flex-wrap: wrap; gap: 10px;">
                            <div style="display:flex; align-items:center; flex-wrap: wrap; gap:6px;">
                                <b style="font-size:16px; word-break: break-all;">@${lot.target_username}</b>
                                <div style="display: flex; align-items: center; flex-shrink: 0;">${verifiedBadge}${vipBadge}${privateBadge}</div>
                            </div>
                            <span style="font-size:11px; font-weight:700; color:${statusColor}; background:${statusBg}; padding: 4px 8px; border-radius: 8px; white-space: nowrap;">${statusText}</span>
                        </div>
                        <div style="font-size:14px; color: #cbd5e1;">–¶–µ–Ω–∞: <b>${lot.price} TON</b>${holdText}</div>
                        ${actionButtons}
                    </div>`
                }).join('');
            } catch (e) { }
        }

        async function openHistoryModal() {
            showActionModal(`<h3>${_t('loading')}</h3>`);
            try {
                const res = await fetch(`${API_URL}/users/${user.id}/transactions`, { headers });
                const txs = await res.json();
                let historyStr = currentLang === 'en' ? 'üìú History' : 'üìú –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π';
                
                if (txs.length === 0) return showActionModal(`<h3 style="margin-top:0;">${historyStr}</h3><p style="color:var(--text-dim);">${_t('nothing')}</p><button class="btn-main" onclick="closeActionModal()">${_t('ok')}</button>`);

                const txHtml = txs.map(t => {
                    let color = t.amount > 0 ? 'var(--success)' : 'var(--error)';
                    let sign = t.amount > 0 ? '+' : '';
                    let typeName = t.type;
                    if(currentLang === 'ru') {
                        typeName = t.type === 'deposit' ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : t.type === 'withdrawal' ? '–í—ã–≤–æ–¥ / –ü–æ–∫—É–ø–∫–∞' : t.type === 'sale_income' ? '–ü—Ä–æ–¥–∞–∂–∞ –ª–æ—Ç–∞' : t.type === 'commission_fee' ? (t.amount > 0 ? '–ö–æ–º–∏—Å—Å–∏—è / –†–µ—Ñ–µ—Ä–∞–ª' : '–ö–æ–º–∏—Å—Å–∏—è —Å–∏—Å—Ç–µ–º—ã') : t.type;
                    }
                    let statusIcon = t.status === 'completed' ? '‚úÖ' : t.status === 'pending' ? '‚è≥' : '‚ùå';
                    return `<div style="background:rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding:12px; border-radius:16px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; text-align:left;"><div><div style="font-weight:600; font-size:13px; margin-bottom:4px;">${statusIcon} ${typeName}</div><div style="color:var(--text-dim); font-size:11px;">${t.date}</div></div><div style="color:${color}; font-weight:800; font-size:15px;">${sign}${t.amount} TON</div></div>`;
                }).join('');

                showActionModal(`<h3 style="margin-top:0; margin-bottom:15px;">${historyStr}</h3><div class="history-container" style="max-height:55vh; overflow-y:auto; padding-right:5px; margin-bottom:15px;">${txHtml}</div><button class="btn-main" onclick="closeActionModal()">${_t('ok')}</button>`);
            } catch (e) { showNotification(_t('error'), "error"); closeActionModal(); }
        }

        function openVipModal(lotId, tag) {
            let costText = freeVipTickets > 0 ? `<span style='color:#10b981;'>${currentLang === 'en' ? 'Free' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'} (1)</span>` : `<span style='color:#fbbf24;'>0.5 TON</span>`;
            let btnText = freeVipTickets > 0 ? (currentLang === 'en' ? "Use Ticket" : "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—É–ø–æ–Ω") : (currentLang === 'en' ? "Buy VIP" : "–ö—É–ø–∏—Ç—å VIP");
            let titleStr = currentLang === 'en' ? `üî• VIP Boost` : `üî• VIP –†–∞–∑–º–µ—â–µ–Ω–∏–µ`;
            let descStr = currentLang === 'en' ? `Your lot <b style="word-break: break-all; color:white;">@${tag}</b> will be pinned at the top.` : `–í–∞—à –ª–æ—Ç <b style="word-break: break-all; color:white;">@${tag}</b> –±—É–¥–µ—Ç –∑–∞–∫—Ä–µ–ø–ª–µ–Ω –Ω–∞ —Å–∞–º–æ–º –≤–µ—Ä—Ö—É.`;
            let priceStr = currentLang === 'en' ? 'Price:' : '–°—Ç–æ–∏–º–æ—Å—Ç—å:';
            let deductStr = currentLang === 'en' ? 'Will be deducted from your balance.' : '–°—É–º–º–∞ —Å–ø–∏—à–µ—Ç—Å—è —Å –≤–∞—à–µ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞.';
            
            showActionModal(`
                <h3 style="margin-top:0; color:#fbbf24;">${titleStr}</h3>
                <p style="font-size:14px; color:var(--text-dim); line-height: 1.6;">${descStr}</p>
                <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin: 15px 0;">
                    <div style="font-size: 13px; color:var(--text-dim); text-transform:uppercase;">${priceStr}</div>
                    <div style="font-size: 20px; font-weight: bold;">${costText}</div>
                </div>
                <div class="flex-btns">
                    <button class="btn-cancel" onclick="closeActionModal()">${_t('cancel')}</button>
                    <button class="btn-confirm" style="background:#f59e0b; color:#000;" onclick="submitVip(${lotId})">${btnText}</button>
                </div>
                ${freeVipTickets === 0 ? `<p style="font-size:11px; color:var(--warning); margin-top:10px;">${deductStr}</p>` : ''}
            `);
        }

        async function submitVip(lotId) {
            closeActionModal();
            try {
                const res = await fetch(`${API_URL}/lots/${lotId}/vip`, { method: 'POST', headers, body: JSON.stringify({ user_id: user.id }) });
                if (res.ok) { showNotification(_t('success'), "success"); renderProfile(); fetchLots(); fetchUserData();
                } else { showNotification(_t('error'), "error"); }
            } catch (e) { showNotification(_t('error'), "error"); }
        }

        function openPromoModal() {
            let titleStr = currentLang === 'en' ? `üéÅ Promo Code` : `üéÅ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞`;
            let descStr = currentLang === 'en' ? `Enter promo code to get bonuses.` : `–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å—ã.`;
            let actStr = currentLang === 'en' ? `Activate` : `–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å`;
            
            showActionModal(`
                <h3 style="margin-top:0;">${titleStr}</h3>
                <p style="font-size:13px; color:var(--text-dim); margin-bottom: 20px;">${descStr}</p>
                <input type="text" id="promo-input" placeholder="START2026" style="text-transform: uppercase; text-align: center; font-weight: bold; letter-spacing: 2px;">
                <div class="flex-btns">
                    <button class="btn-cancel" onclick="closeActionModal()">${_t('cancel')}</button>
                    <button class="btn-confirm" style="background:var(--premium-color);" onclick="submitPromo()">${actStr}</button>
                </div>
            `);
        }

        async function submitPromo() {
            const code = document.getElementById('promo-input').value.trim();
            if(!code) return showNotification(_t('error'), "error");
            closeActionModal();
            try {
                const res = await fetch(`${API_URL}/promo/apply`, { method: 'POST', headers, body: JSON.stringify({ user_id: user.id, code: code }) });
                if (res.ok) { showNotification(_t('success'), "success"); fetchUserData();
                } else { showNotification(_t('error'), "error"); }
            } catch(e) { showNotification(_t('error'), "error"); }
        }

        function openStarsDepositModal() {
            let titleStr = currentLang === 'en' ? `‚≠êÔ∏è Stars Deposit` : `–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ‚≠êÔ∏è`;
            let descStr = currentLang === 'en' ? `Enter TON amount.` : `–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ TON.`;
            let payStr = currentLang === 'en' ? `Pay:` : `–ö –æ–ø–ª–∞—Ç–µ:`;
            let btnStr = currentLang === 'en' ? `Pay Stars` : `–û–ø–ª–∞—Ç–∏—Ç—å Stars`;
            
            showActionModal(`
                <h3 style="margin-top:0;">${titleStr}</h3>
                <p style="font-size:13px; color:var(--text-dim); line-height:1.5;">${descStr}</p>
                <input type="number" id="stars-ton-input" placeholder="TON" style="text-align:center; font-size:20px; font-weight:bold;">
                <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                    <div style="font-size:12px; color:var(--warning); text-transform:uppercase;">${payStr}</div>
                    <div id="stars-calc-hint" style="color:#fff; font-size:24px; font-weight:800; margin-top:5px;">0 ‚≠êÔ∏è</div>
                </div>
                <div class="flex-btns">
                    <button class="btn-cancel" onclick="closeActionModal()">${_t('cancel')}</button>
                    <button class="btn-confirm" style="background:#f59e0b; color:#000;" onclick="submitStarsDeposit()">${btnStr}</button>
                </div>
            `);
            document.getElementById('stars-ton-input').addEventListener('input', function() {
                const val = parseFloat(this.value);
                const hint = document.getElementById('stars-calc-hint');
                if (!isNaN(val) && val > 0) hint.innerHTML = `${Math.ceil(val * 87)} ‚≠êÔ∏è`; 
                else hint.innerHTML = `0 ‚≠êÔ∏è`;
            });
        }

        async function submitStarsDeposit() {
            const tonAmount = parseFloat(document.getElementById('stars-ton-input').value);
            if (isNaN(tonAmount) || tonAmount < 0.1) return showNotification(_t('error'), "error");
            closeActionModal(); showNotification(_t('loading'), "info");
            try {
                const res = await fetch(`${API_URL}/deposit/stars`, { method: 'POST', headers, body: JSON.stringify({ user_id: user.id, ton_amount: tonAmount }) });
                const data = await res.json();
                if (res.ok && data.invoice_link) {
                    tg.openInvoice(data.invoice_link, function(status) {
                        if (status === 'paid') { showNotification(_t('success'), "success"); setTimeout(fetchUserData, 1500); 
                        } else if (status === 'failed') { showNotification(_t('error'), "error"); }
                    });
                } else { showNotification(_t('error'), "error"); }
            } catch(e) { showNotification(_t('error'), "error"); }
        }

        function openOfferModal(lotId, tag, currentPrice) {
            let titleStr = currentLang === 'en' ? `Offer for <span style="word-break: break-all;">@${tag}</span>` : `–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ü–µ–Ω—É –∑–∞ <span style="word-break: break-all;">@${tag}</span>`;
            let hintStr = currentLang === 'en' ? `The seller will get a notification.` : `–ü—Ä–æ–¥–∞–≤—Ü—É –ø—Ä–∏–¥–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –ï—Å–ª–∏ –æ–Ω —Å–æ–≥–ª–∞—Å–∏—Ç—Å—è, —Å–¥–µ–ª–∫–∞ –ø—Ä–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`;
            let sendStr = currentLang === 'en' ? `Send` : `–û—Ç–ø—Ä–∞–≤–∏—Ç—å`;
            
            showActionModal(`
                <h3 style="margin-top:0;">${titleStr}</h3>
                <p style="font-size:13px; color:var(--text-dim);">${_t('current_bid')} <b>${currentPrice} TON</b></p>
                <input type="number" id="offer-input" placeholder="TON">
                <div class="flex-btns">
                    <button class="btn-cancel" onclick="closeActionModal()">${_t('cancel')}</button>
                    <button class="btn-confirm" onclick="submitOffer(${lotId}, ${currentPrice})">${sendStr}</button>
                </div>
                <p style="font-size:11px; color:var(--text-dim); margin-top:10px;">${hintStr}</p>
            `);
        }

        async function submitOffer(lotId, currentPrice) {
            const amount = parseFloat(document.getElementById('offer-input').value);
            if (isNaN(amount) || amount <= 0 || amount >= currentPrice) return showNotification(_t('error'), "error");
            showActionModal(`<h3>${_t('loading')}</h3>`);
            try {
                const res = await fetch(`${API_URL}/lots/${lotId}/offers`, { method: 'POST', headers, body: JSON.stringify({ buyer_id: user.id, amount: amount }) });
                if (res.ok) { showNotification(_t('success'), "success"); closeActionModal();
                } else { showNotification(_t('error'), "error"); closeActionModal(); }
            } catch(e) { showNotification(_t('error'), "error"); closeActionModal(); }
        }

        async function openOffersModal() {
            showActionModal(`<h3>${_t('loading')}</h3>`);
            try {
                const res = await fetch(`${API_URL}/users/${user.id}/offers`, { headers });
                const offers = await res.json();
                let titleStr = currentLang === 'en' ? 'ü§ù My Offers' : 'ü§ù –ú–æ–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è';
                
                if (offers.length === 0) return showActionModal(`<h3 style="margin-top:0;">${titleStr}</h3><p style="color:var(--text-dim);">${_t('nothing')}</p><button class="btn-main" onclick="closeActionModal()">${_t('ok')}</button>`);
                
                const offersHtml = offers.map(o => {
                    let statusColor = o.status === 'pending' ? 'var(--warning)' : o.status === 'accepted' ? 'var(--success)' : 'var(--error)';
                    return `<div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:16px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; text-align:left;"><div style="max-width: 60%;"><div style="font-weight:700; font-size:15px; margin-bottom:4px; word-break: break-all;">@${o.target_username}</div><div style="font-size:12px; color:${statusColor}; font-weight:bold;">${o.status}</div></div><div style="text-align:right;"><div style="font-size:11px; text-decoration:line-through; color:var(--text-dim);">${o.original_price} TON</div><div style="color:var(--accent-color); font-weight:800; font-size:15px;">${o.amount} TON</div></div></div>`;
                }).join('');
                
                showActionModal(`<h3 style="margin-top:0; margin-bottom:15px;">${titleStr}</h3><div class="history-container" style="max-height:55vh; overflow-y:auto; padding-right:5px; margin-bottom:15px;">${offersHtml}</div><button class="btn-main" onclick="closeActionModal()">${_t('ok')}</button>`);
            } catch (e) { showNotification(_t('error'), "error"); closeActionModal(); }
        }

        function openPriceModal(lotId, tag) {
            let titleStr = currentLang === 'en' ? `Change Price <span style="word-break: break-all;">@${tag}</span>` : `–ù–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è <span style="word-break: break-all;">@${tag}</span>`;
            let saveStr = currentLang === 'en' ? `Save` : `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å`;
            showActionModal(`
                <h3 style="margin-top:0;">${titleStr}</h3>
                <input type="number" id="new-price-input" placeholder="TON" oninput="window.updateModalPriceHint(this.value)">
                <div id="modal-price-calc-hint" style="color: var(--warning); font-size: 13px; margin-top: -5px; margin-bottom: 12px; display: none; text-align: right; font-weight: 600;"></div>
                <div class="flex-btns">
                    <button class="btn-cancel" onclick="closeActionModal()">${_t('cancel')}</button>
                    <button class="btn-confirm" onclick="submitPriceChange(${lotId})">${saveStr}</button>
                </div>
            `);
        }
        
        async function submitPriceChange(lotId) {
            const val = document.getElementById('new-price-input').value;
            if(!val || isNaN(val)) return showNotification(_t('error'), "error");
            closeActionModal();
            try {
                await fetch(`${API_URL}/lots/${lotId}/price`, { method: 'PATCH', headers, body: JSON.stringify({ new_price: parseFloat(val) }) });
                showNotification(_t('success'), "success"); renderProfile(); fetchLots();
            } catch(e) { showNotification(_t('error'), "error"); }
        }

        function openRecallModal(lotId, tag) {
            let titleStr = currentLang === 'en' ? `Recall <span style="word-break: break-all;">@${tag}</span>?` : `–í–µ—Ä–Ω—É—Ç—å –∫–∞–Ω–∞–ª <span style="word-break: break-all;">@${tag}</span>?`;
            let descStr = currentLang === 'en' ? `Item will be removed, bot transfers ownership back.` : `–õ–æ—Ç –±—É–¥–µ—Ç —Å–Ω—è—Ç —Å –ø—Ä–æ–¥–∞–∂–∏, –∞ –±–æ—Ç –≤–µ—Ä–Ω–µ—Ç –≤–∞–º –ø—Ä–∞–≤–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞.`;
            showActionModal(`
                <h3 style="margin-top:0;">${titleStr}</h3>
                <p style="font-size:14px; color:var(--text-dim);">${descStr}</p>
                <div class="flex-btns">
                    <button class="btn-cancel" onclick="closeActionModal()">${_t('cancel')}</button>
                    <button class="btn-confirm" style="background:var(--error);" onclick="submitRecall(${lotId})">${_t('recall')}</button>
                </div>
            `);
        }
        
        async function submitRecall(lotId) {
            closeActionModal();
            try {
                const res = await fetch(`${API_URL}/lots/${lotId}/recall`, { method: 'POST', headers });
                if(res.ok) { showNotification(_t('success'), "success"); renderProfile(); fetchLots(); 
                } else { showNotification(_t('error'), "error"); }
            } catch(e) { showNotification(_t('error'), "error"); }
        }

        function openWithdrawModal() {
            const avail = document.getElementById('avail-balance').innerText;
            let titleStr = currentLang === 'en' ? `Withdraw` : `–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥`;
            let availStr = currentLang === 'en' ? `Available:` : `–î–æ—Å—Ç—É–ø–Ω–æ:`;
            let btnStr = currentLang === 'en' ? `Withdraw` : `–í—ã–≤–µ—Å—Ç–∏`;
            showActionModal(`
                <h3 style="margin-top:0;">${titleStr}</h3>
                <p style="font-size:12px; color:var(--text-dim); margin-bottom:15px;">${availStr} ${avail}</p>
                <input type="number" id="withdraw-amount" placeholder="TON">
                <input type="text" id="withdraw-wallet" placeholder="Wallet">
                <div class="flex-btns">
                    <button class="btn-cancel" onclick="closeActionModal()">${_t('cancel')}</button>
                    <button class="btn-confirm" onclick="submitWithdraw()">${btnStr}</button>
                </div>
            `);
        }
        
        async function submitWithdraw() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const wallet = document.getElementById('withdraw-wallet').value;
            const available = parseFloat(document.getElementById('avail-balance').innerText);
            if (isNaN(amount) || amount <= 0 || !wallet) return showNotification(_t('error'), "error");
            closeActionModal();
            try {
                const res = await fetch(`${API_URL}/withdraw`, { method: 'POST', headers, body: JSON.stringify({ user_id: user.id, amount: amount, wallet_address: wallet.trim() }) });
                if (res.ok) { showNotification(_t('success'), "success"); fetchUserData(); 
                } else { showNotification(_t('error'), "error"); }
            } catch (e) { showNotification(_t('error'), "error"); }
        }

        function openBuyModal(lotId, price, tag = "tag") {
            let internal = parseFloat(document.getElementById('avail-balance')?.innerText || "0");
            let titleStr = currentLang === 'en' ? `Pay with Balance` : `–û–ø–ª–∞—Ç–∞ —Å –±–∞–ª–∞–Ω—Å–∞`;
            let descStr = currentLang === 'en' ? `You have ${internal} TON.<br>Pay <b>${price} TON</b>?` : `–£ –≤–∞—Å ${internal} TON.<br>–°–ø–∏—Å–∞—Ç—å <b>${price} TON</b>?`;
            
            if (internal >= price) {
                showActionModal(`
                    <h3 style="margin-top:0;">${titleStr}</h3>
                    <p style="font-size:14px; color:var(--text-dim);">${descStr}</p>
                    <div class="flex-btns">
                        <button class="btn-cancel" onclick="closeActionModal()">${_t('cancel')}</button>
                        <button class="btn-confirm" onclick="submitInternalBuy(${lotId})">${_t('buy')}</button>
                    </div>
                `);
            } else {
                if (!tonConnectUI.connected) return showNotification(_t('connect_wallet'), "warning");
                proceedTonBuy(lotId, price);
            }
        }
        
        async function submitInternalBuy(lotId) {
            closeActionModal();
            try {
                const res = await fetch(`${API_URL}/lots/${lotId}/buy-internal`, { method: 'POST', headers, body: JSON.stringify({ buyer_id: user.id }) });
                if (res.ok) { showNotification(_t('success'), "success"); fetchLots(); fetchUserData(); 
                } else { showNotification(_t('error'), "error"); }
            } catch(e) { showNotification(_t('error'), "error"); }
        }
        
        async function proceedTonBuy(lotId, price) {
            const cell = new TonWeb.boc.Cell(); 
            cell.bits.writeUint(0, 32); cell.bits.writeString(`buy_lot_${lotId}`);
            const payloadBase64 = TonWeb.utils.bytesToBase64(await cell.toBoc(false));
            try {
                await tonConnectUI.sendTransaction({ 
                    validUntil: Math.floor(Date.now() / 1000) + 360, 
                    messages: [{ address: "UQDKJrZT85ZyMPVkc0d2Q3kPIzOb4YEmJSb-oVtAZE-71AaU", amount: (price * 1000000000).toString(), payload: payloadBase64 }] 
                });
                showNotification("Sent!", "info");
                await fetch(`${API_URL}/lots/${lotId}/verify-payment`, { method: 'POST', headers, body: JSON.stringify({ boc: "sent", buyer_id: user.id }) });
            } catch (e) { showNotification(_t('error'), "error"); }
        }

        function switchTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active'); 
            element.classList.add('active');
            if(tabId === 'profile') { fetchUserData(); renderProfile(); }
            if(tabId === 'market') fetchLots();
            if(tabId === 'auctions') fetchAuctions();
            if(tabId === 'wtb') fetchWTB();
        }

        function openConfirmModal() {
            const tag = document.getElementById('username-input').value.replace('@', '').trim();
            const price = document.getElementById('price-input').value;
            const isPrivate = document.getElementById('is-private-checkbox').checked; // üí° –°—á–∏—Ç—ã–≤–∞–µ–º –≥–∞–ª–æ—á–∫—É
            
            if (!tag || !price) return showNotification(_t('error'), "error");
            document.getElementById('confirm-tag').innerText = tag; document.getElementById('confirm-price').innerText = price;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            document.getElementById('dynamic-confirm-btn').dataset.private = isPrivate;
            
            document.getElementById('modal-step-1').style.display = 'block'; document.getElementById('modal-step-2').style.display = 'none'; document.getElementById('modal-step-3').style.display = 'none';
            document.getElementById('dynamic-confirm-btn').onclick = confirmAndSend;
            document.getElementById('dynamic-confirm-btn').innerText = currentLang === 'en' ? 'List and Start Timer' : '–í—ã—Å—Ç–∞–≤–∏—Ç—å –∏ –Ω–∞—á–∞—Ç—å —Ç–∞–π–º–µ—Ä';
            document.getElementById('custom-modal').style.display = 'flex';
        }

        async function confirmAndSend() {
            const tag = document.getElementById('confirm-tag').innerText;
            const price = document.getElementById('confirm-price').innerText;
            const isPrivate = document.getElementById('dynamic-confirm-btn').dataset.private === 'true'; // üí° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥
            
            try {
                const res = await fetch(`${API_URL}/lots`, { method: 'POST', headers, body: JSON.stringify({ user_id: user.id, target_username: tag, price: parseFloat(price), is_private: isPrivate }) });
                const data = await res.json();
                if (res.ok) { document.getElementById('modal-step-1').style.display = 'none'; document.getElementById('modal-step-2').style.display = 'block'; startTimer(data.lot_id); 
                } else { showNotification(_t('error'), "error"); closeModal(); }
            } catch (e) { showNotification(_t('error'), "error"); }
        }

        function openConfirmAuctionModal() {
            const tag = document.getElementById('auc-username-input').value.replace('@', '').trim();
            const price = document.getElementById('auc-price-input').value;
            const duration = document.getElementById('auc-duration-input').value;
            if (!tag || !price) return showNotification(_t('error'), "error");
            document.getElementById('confirm-tag').innerText = tag; document.getElementById('confirm-price').innerText = price;
            document.getElementById('modal-step-1').style.display = 'block'; document.getElementById('modal-step-2').style.display = 'none'; document.getElementById('modal-step-3').style.display = 'none';
            document.getElementById('dynamic-confirm-btn').onclick = () => confirmAndSendAuction(tag, price, duration);
            document.getElementById('dynamic-confirm-btn').innerText = currentLang === 'en' ? 'Start Auction' : '–í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω';
            document.getElementById('custom-modal').style.display = 'flex';
        }

        async function confirmAndSendAuction(tag, price, duration) {
            try {
                const res = await fetch(`${API_URL}/auctions`, { method: 'POST', headers, body: JSON.stringify({ user_id: user.id, target_username: tag, start_price: parseFloat(price), duration_hours: parseInt(duration) }) });
                const data = await res.json();
                if (res.ok) { document.getElementById('modal-step-1').style.display = 'none'; document.getElementById('modal-step-2').style.display = 'block'; startTimerCheckAuction(data.auction_id); 
                } else { showNotification(_t('error'), "error"); closeModal(); }
            } catch (e) { showNotification(_t('error'), "error"); }
        }

        function startTimerCheckAuction(aucId) {
            clearInterval(timerInterval); clearInterval(statusInterval);
            let time = 300; const el = document.getElementById('countdown'); el.innerText = "05:00";
            timerInterval = setInterval(() => { 
                time--; el.innerText = `${Math.floor(time / 60).toString().padStart(2, '0')}:${(time % 60).toString().padStart(2, '0')}`; 
                if (time <= 0) { clearInterval(timerInterval); clearInterval(statusInterval); closeModal(); showNotification(_t('error'), "error"); } 
            }, 1000);
            statusInterval = setInterval(async () => { 
                try { 
                    const res = await fetch(`${API_URL}/auctions/${aucId}/status`, { headers }); 
                    if (res.ok) { const data = await res.json(); if (data.status === 'active') { clearInterval(timerInterval); clearInterval(statusInterval); document.getElementById('modal-step-2').style.display = 'none'; document.getElementById('modal-step-3').style.display = 'block'; } } 
                } catch(e) {} 
            }, 5000);
        }
        
        function startTimer(lotId) {
            clearInterval(timerInterval); clearInterval(statusInterval);
            let time = 300; const el = document.getElementById('countdown'); el.innerText = "05:00";
            timerInterval = setInterval(() => { 
                time--; el.innerText = `${Math.floor(time / 60).toString().padStart(2, '0')}:${(time % 60).toString().padStart(2, '0')}`; 
                if (time <= 0) { clearInterval(timerInterval); clearInterval(statusInterval); closeModal(); showNotification(_t('error'), "error"); } 
            }, 1000);
            statusInterval = setInterval(async () => { 
                try { 
                    const res = await fetch(`${API_URL}/lots/${lotId}/status`, { headers }); 
                    if (res.ok) { const data = await res.json(); if (data.status === 'active') { clearInterval(timerInterval); clearInterval(statusInterval); document.getElementById('modal-step-2').style.display = 'none'; document.getElementById('modal-step-3').style.display = 'block'; } } 
                } catch(e) {} 
            }, 5000);
        }

        function closeModal() { document.getElementById('custom-modal').style.display = 'none'; clearInterval(timerInterval); clearInterval(statusInterval); }
        function closeModalAndRefresh() { closeModal(); fetchLots(); fetchAuctions(); if(document.getElementById('tab-profile').classList.contains('active')) renderProfile(); }

        // ==========================================
        // üõ† –õ–û–ì–ò–ö–ê –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–ò 
        // ==========================================
        async function loadAdminStats() {
            try {
                const res = await fetch(`${API_URL}/admin/stats?admin_id=${ADMIN_ID}`, {headers});
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('admin-stats').innerHTML = `
                        <div><div style="font-size:20px; font-weight:bold; color:white;">${data.users}</div>üë• –Æ–∑–µ—Ä—ã</div>
                        <div><div style="font-size:20px; font-weight:bold; color:var(--success);">${data.lots}</div>üî• –õ–æ—Ç—ã</div>
                        <div><div style="font-size:20px; font-weight:bold; color:var(--warning);">${data.withdrawals}</div>‚è≥ –í—ã–≤–æ–¥—ã</div>
                    `;
                }
            } catch (e) {}
        }

        async function loadAdminWithdrawals() {
            try {
                const res = await fetch(`${API_URL}/admin/withdrawals?admin_id=${ADMIN_ID}`, {headers});
                if (res.ok) {
                    const data = await res.json();
                    const container = document.getElementById('admin-withdrawals');
                    if (data.length === 0) {
                        container.innerHTML = `<div style="color:var(--text-dim); font-size:13px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫.</div>`;
                        return;
                    }
                    container.innerHTML = data.map(w => `
                        <div style="background:rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding:12px; border-radius:12px; margin-bottom:10px;">
                            <div style="font-size:12px; color:var(--text-dim);">ID: ${w.user_id}</div>
                            <div style="font-size:16px; font-weight:bold; color:var(--accent-color); margin:4px 0;">${w.amount} TON</div>
                            <div style="font-size:11px; word-break:break-all; margin-bottom:10px; color:white;">${w.wallet}</div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn-main btn-small" style="background:var(--success); flex:1;" onclick="processWithdrawal(${w.id}, 'approve')">‚úÖ –í—ã–¥–∞–ª</button>
                                <button class="btn-main btn-small" style="background:var(--error); flex:1;" onclick="processWithdrawal(${w.id}, 'reject')">‚ùå –û—Ç–∫–∞–∑</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {}
        }

        async function processWithdrawal(id, action) {
            try {
                const res = await fetch(`${API_URL}/admin/withdrawals/${id}`, {
                    method: 'POST', headers, body: JSON.stringify({ admin_id: ADMIN_ID, action: action })
                });
                if (res.ok) { showNotification("–ó–∞—è–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞!", "success"); loadAdminWithdrawals(); }
                else { showNotification("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏", "error"); }
            } catch(e) {}
        }

        async function adminAddBalance() {
            const tid = document.getElementById('admin-bal-id').value;
            const amount = document.getElementById('admin-bal-amount').value;
            if(!tid || !amount) return showNotification("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è", "error");
            try {
                const res = await fetch(`${API_URL}/admin/balance`, {
                    method: 'POST', headers, body: JSON.stringify({ admin_id: ADMIN_ID, target_id: parseInt(tid), amount: parseFloat(amount) })
                });
                if (res.ok) { showNotification("–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω!", "success"); document.getElementById('admin-bal-id').value = ''; document.getElementById('admin-bal-amount').value = ''; }
            } catch(e) {}
        }

        async function adminVerify() {
            const tid = document.getElementById('admin-ver-id').value;
            if(!tid) return showNotification("–í–≤–µ–¥–∏—Ç–µ ID", "error");
            try {
                const res = await fetch(`${API_URL}/admin/verify`, {
                    method: 'POST', headers, body: JSON.stringify({ admin_id: ADMIN_ID, target_id: parseInt(tid) })
                });
                if (res.ok) { showNotification("–ì–∞–ª–æ—á–∫–∞ –≤—ã–¥–∞–Ω–∞!", "success"); document.getElementById('admin-ver-id').value = ''; }
            } catch(e) {}
        }

        async function adminCreatePromo() {
            const code = document.getElementById('admin-promo-code').value;
            const uses = document.getElementById('admin-promo-uses').value;
            const tix = document.getElementById('admin-promo-tickets').value;
            if(!code || !uses || !tix) return showNotification("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è", "error");
            try {
                const res = await fetch(`${API_URL}/admin/promo`, {
                    method: 'POST', headers, body: JSON.stringify({ admin_id: ADMIN_ID, code: code, uses: parseInt(uses), tickets: parseInt(tix) })
                });
                if (res.ok) { showNotification("–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!", "success"); }
                else { showNotification("–û—à–∏–±–∫–∞ –∏–ª–∏ –∫–æ–¥ —É–∂–µ –µ—Å—Ç—å", "error"); }
            } catch(e) {}
        }
    </script>
</body>
</html>
