<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TakeMyTag Premium Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/tonweb/dist/tonweb.js"></script>
    
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --accent-color: #38bdf8;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: var(--text-main);
            margin: 0;
            padding: 16px;
            padding-bottom: 80px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é */
            min-height: 100vh;
            overflow-x: hidden;
        }

        #ton-connect-button {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .balance-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            padding: 20px;
            border-radius: 24px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 24px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
        }

        .balance-label { color: var(--text-dim); font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }
        .balance-value { font-size: 28px; font-weight: 800; color: var(--accent-color); margin-top: 5px; }

        .input-box {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        input, select {
            width: 100%;
            padding: 14px;
            margin-bottom: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.3s;
        }
        input:focus, select:focus { border-color: var(--accent-color); }

        .btn-main {
            background: linear-gradient(135deg, #0ea5e9, #2563eb);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 14px;
            width: 100%;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-small { padding: 10px; font-size: 14px; border-radius: 10px; }

        .section-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; padding-left: 5px; }

        .lot-item {
            background: var(--card-bg);
            padding: 18px;
            border-radius: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .buy-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- –í–ö–õ–ê–î–ö–ò –ò –ú–ï–ù–Æ --- */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(15px);
            display: flex; justify-content: space-around; padding: 15px 0;
            border-top: 1px solid rgba(255,255,255,0.1); z-index: 100;
        }
        .nav-item { color: var(--text-dim); font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; text-align: center; }
        .nav-item.active { color: var(--accent-color); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 4px; }

        /* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û --- */
        #custom-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 28px;
            width: 85%;
            max-width: 400px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .step-num {
            background: var(--accent-color);
            color: white;
            width: 26px; height: 26px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center; justify-content: center;
            margin-right: 10px;
            font-size: 12px;
        }
        
        .timer-text { font-size: 34px; font-weight: 800; color: #ef4444; margin: 15px 0; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div id="ton-connect-button"></div>

    <div id="tab-market" class="tab-content active">
        <div class="balance-card">
            <div class="balance-label">–°—Ç–∞—Ç—É—Å –∫–æ—à–µ–ª—å–∫–∞</div>
            <div id="wallet-status" class="balance-value" style="font-size: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="input-box">
            <div class="section-title" style="margin-top: 0;">üíé –ü—Ä–æ–¥–∞—Ç—å —é–∑–µ—Ä–Ω–µ–π–º</div>
            <input type="text" id="username-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: tag_name">
            <input type="number" id="price-input" placeholder="–¶–µ–Ω–∞ –≤ TON">
            <button class="btn-main" onclick="openConfirmModal()">–í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –º–∞—Ä–∫–µ—Ç</button>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <div class="section-title" style="margin:0;">üî• –í–∏—Ç—Ä–∏–Ω–∞</div>
            <select id="filter-select" onchange="renderMarket()" style="width:140px; margin:0; padding:8px 12px; font-size: 13px;">
                <option value="new">–ù–æ–≤—ã–µ</option>
                <option value="price_asc">–ü–æ–¥–µ—à–µ–≤–ª–µ</option>
                <option value="price_desc">–ü–æ–¥–æ—Ä–æ–∂–µ</option>
                <option value="len_asc">–ö–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–≥–∏</option>
                <option value="len_desc">–î–ª–∏–Ω–Ω—ã–µ —Ç–µ–≥–∏</option>
            </select>
        </div>
        <div id="lots-container"></div>
    </div>

    <div id="tab-profile" class="tab-content">
        <div class="balance-card" style="text-align: left;">
            <div class="balance-label" id="profile-name" style="text-align: center; margin-bottom: 15px;">–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</div>
            
            <div style="display: flex; justify-content: space-between; text-align: center; margin-bottom: 15px;">
                <div style="width: 48%; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px;">
                    <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase;">–î–æ—Å—Ç—É–ø–Ω–æ</div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--success);" id="avail-balance">0.00 TON</div>
                </div>
                <div style="width: 48%; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px;">
                    <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase;">–í —Ö–æ–ª–¥–µ</div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--warning);" id="froz-balance">0.00 TON</div>
                </div>
            </div>
            
            <button class="btn-main btn-small" style="background: #334155; width: 100%;" onclick="requestWithdraw()">üí∏ –ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–≤–æ–¥</button>
        </div>
        <div class="section-title">–ú–æ–∏ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –ª–æ—Ç—ã</div>
        <div id="profile-list"></div>
    </div>

    <div id="tab-info" class="tab-content">
        <div class="input-box" style="line-height: 1.6; color: var(--text-dim);">
            <h2 style="color: white; margin-top: 0;">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <p><b>–ö–∞–∫ –ø—Ä–æ–¥–∞—Ç—å —é–∑–µ—Ä–Ω–µ–π–º?</b><br>1. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥ –∏ —Ü–µ–Ω—É –≤ —Ä–∞–∑–¥–µ–ª–µ –ú–∞—Ä–∫–µ—Ç.<br>2. –ù–∞–∂–º–∏—Ç–µ "–í—ã—Å—Ç–∞–≤–∏—Ç—å".<br>3. –ü–µ—Ä–µ–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–∞—à–µ–º—É –±–æ—Ç—É <b>@TakeMyTag1</b> –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç.</p>
            <p><b>–ö–æ–º–∏—Å—Å–∏—è:</b><br>–°–∏—Å—Ç–µ–º–∞ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ–≥–æ <b style="color: var(--accent-color);">2%</b> –æ—Ç —Å—É–º–º—ã —Å–¥–µ–ª–∫–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–æ–≤.</p>
            <p><b>–ó–∞–º–æ—Ä–æ–∑–∫–∞ (–•–æ–ª–¥):</b><br>–ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞—é—Ç—Å—è –Ω–∞ 1 —á–∞—Å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–¥–µ–ª–∫–∏, –ø–æ—Å–ª–µ —á–µ–≥–æ –ø–æ—Å—Ç—É–ø–∞—é—Ç –Ω–∞ –≤–∞—à –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å.</p>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('market', this)">
            <span class="nav-icon">üõí</span>–ú–∞—Ä–∫–µ—Ç
        </div>
        <div class="nav-item" onclick="switchTab('profile', this)">
            <span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å
        </div>
        <div class="nav-item" onclick="switchTab('info', this)">
            <span class="nav-icon">‚ÑπÔ∏è</span>–ò–Ω—Ñ–æ
        </div>
    </div>

    <div id="custom-modal">
        <div class="modal-content">
            
            <div id="modal-step-1">
                <h2 style="margin-top:0; font-size: 22px;">–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ!</h2>
                <div style="text-align:left; font-size: 14px; line-height: 1.6; color: #cbd5e1;">
                    <p><span class="step-num">1</span> –¶–µ–Ω–∞ –ª–æ—Ç–∞: <b id="confirm-price" style="color:white">0</b> TON</p>
                    <p><span class="step-num">2</span> –ü–µ—Ä–µ–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–∞–Ω–∞–ª–∞ <b>@<span id="confirm-tag" style="color:white"></span></b> –∞–∫–∫–∞—É–Ω—Ç—É:</p>
                    <div style="background:rgba(0,0,0,0.4); padding:12px; border-radius:12px; text-align:center; font-weight:bold; color:#38bdf8; font-size: 16px; border: 1px dashed #38bdf8;">
                        @TakeMyTag1
                    </div>
                    <p style="font-size:11px; color:var(--text-dim); margin-top:12px;">üõ°Ô∏è –Æ–∑–µ—Ä–±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Å—Ç–∞–≤–∏—Ç –ª–æ—Ç –Ω–∞ –≤–∏—Ç—Ä–∏–Ω—É, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ–ª—É—á–∏—Ç –ø—Ä–∞–≤–∞.</p>
                </div>
                <button class="btn-main" onclick="confirmAndSend()" style="margin-top: 25px;">–í—ã—Å—Ç–∞–≤–∏—Ç—å –∏ –Ω–∞—á–∞—Ç—å —Ç–∞–π–º–µ—Ä</button>
                <button onclick="closeModal()" style="background:none; border:none; color:var(--text-dim); margin-top:15px; cursor:pointer; font-size: 14px;">–û—Ç–º–µ–Ω–∞</button>
            </div>

            <div id="modal-step-2" style="display: none;">
                <h2 style="margin-top:0; font-size: 20px;">–û–∂–∏–¥–∞–µ–º –ø—Ä–∞–≤–∞...</h2>
                <p style="color: var(--text-dim); font-size: 14px;">–°–¥–µ–ª–∞–π—Ç–µ <b>@TakeMyTag1</b> –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –∫–∞–Ω–∞–ª–∞.</p>
                <div class="timer-text" id="countdown">05:00</div>
                <p style="font-size: 12px; color: #ef4444;">–ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã–π–¥–µ—Ç ‚Äî –ª–æ—Ç –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω.</p>
                <button class="btn-main btn-small" style="background: #475569; margin-top: 15px;" onclick="closeModal()">–°–≤–µ—Ä–Ω—É—Ç—å –æ–∫–Ω–æ</button>
            </div>

            <div id="modal-step-3" style="display: none;">
                <div style="font-size: 50px; margin-bottom: 10px;">‚úÖ</div>
                <h2 style="margin-top:0; font-size: 22px; color: #10b981;">–£—Å–ø–µ—à–Ω–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω!</h2>
                <p style="color: var(--text-dim); font-size: 14px; line-height: 1.5;">
                    –í–∞—à —é–∑–µ—Ä–Ω–µ–π–º –ø–æ—è–≤–∏–ª—Å—è –Ω–∞ –≤–∏—Ç—Ä–∏–Ω–µ.<br><br>–ú—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç–∞ –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–ø–∏—à–µ–º, –∫–æ–≥–¥–∞ –µ–≥–æ –∫—É–ø—è—Ç!
                </p>
                <button class="btn-main" style="margin-top: 15px;" onclick="closeModalAndRefresh()">–û—Ç–ª–∏—á–Ω–æ</button>
            </div>

        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const API_URL = "https://rapt-noella-myriadly.ngrok-free.dev/api";
        const headers = { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' };
        const user = tg.initDataUnsafe.user;
        let allLots = [];
        let timerInterval;
        let statusInterval;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TonConnect
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://takemytag.vercel.app/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-button'
        });

        tonConnectUI.onStatusChange(wallet => {
            document.getElementById('wallet-status').innerText = wallet ? "–ü–æ–¥–∫–ª—é—á–µ–Ω ‚úÖ" : "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω ‚ùå";
        });

        // --- –ü–û–õ–£–ß–ï–ù–ò–ï –ü–†–û–§–ò–õ–Ø (–û–ë–ù–û–í–õ–ï–ù–û –î–õ–Ø –î–í–£–• –ë–ê–õ–ê–ù–°–û–í) ---
        async function fetchUserData() {
            if (!user) return;
            try {
                const res = await fetch(`${API_URL}/users/${user.id}`, { headers });
                const data = await res.json();
                
                document.getElementById('profile-name').innerText = `–ü—Ä–∏–≤–µ—Ç, ${user.first_name}!`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã –≤ –ø—Ä–æ—Ñ–∏–ª–µ
                document.getElementById('avail-balance').innerText = `${data.available_balance.toFixed(2)} TON`;
                document.getElementById('froz-balance').innerText = `${data.frozen_balance.toFixed(2)} TON`;
            } catch (e) { console.error("DB Sync Error", e); }
        }

        // --- –í–ò–¢–†–ò–ù–ê ---
        async function fetchLots() {
            try {
                const res = await fetch(`${API_URL}/lots`, { headers });
                allLots = await res.json();
                renderMarket();
            } catch (e) {}
        }

        function renderMarket() {
            const filter = document.getElementById('filter-select').value;
            let sorted = [...allLots];
            
            if(filter === 'price_asc') sorted.sort((a,b) => a.price - b.price);
            if(filter === 'price_desc') sorted.sort((a,b) => b.price - a.price);
            if(filter === 'len_asc') sorted.sort((a,b) => a.target_username.length - b.target_username.length);
            if(filter === 'len_desc') sorted.sort((a,b) => b.target_username.length - a.target_username.length);

            const container = document.getElementById('lots-container');
            if (sorted.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-dim);margin-top:20px;">–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–æ—Ç–æ–≤</div>';
                return;
            }

            container.innerHTML = sorted.map(lot => `
                <div class="lot-item">
                    <div>
                        <div style="font-weight:700; font-size:16px;">@${lot.target_username}</div>
                        <div style="color:var(--accent-color); font-weight:600; font-size:14px;">${lot.price} TON</div>
                    </div>
                    <button class="buy-btn" onclick="buyLotWithWallet(${lot.id}, ${lot.price})">–ö—É–ø–∏—Ç—å</button>
                </div>
            `).join('');
        }

        // --- –ü–†–û–§–ò–õ–¨ ---
        async function renderProfile() {
            if(!user) return;
            try {
                const res = await fetch(`${API_URL}/users/${user.id}/lots`, {headers});
                const myLots = await res.json();
                
                const container = document.getElementById('profile-list');
                if(myLots.length === 0) {
                    container.innerHTML = '<div style="text-align:center;color:var(--text-dim);margin-top:20px;">–£ –≤–∞—Å –Ω–µ—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –ª–æ—Ç–æ–≤</div>';
                    return;
                }

                container.innerHTML = myLots.map(lot => {
                    const statusText = lot.status === 'active' ? 'üü¢ –ù–∞ –≤–∏—Ç—Ä–∏–Ω–µ' : lot.status === 'pending_holder' ? 'üü° –ñ–¥–µ—Ç –ø—Ä–∞–≤' : '‚ö™ ' + lot.status;
                    const getAmount = (lot.price * 0.98).toFixed(2);
                    
                    return `
                    <div class="input-box" style="padding:15px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <b style="font-size:18px;">@${lot.target_username}</b>
                            <span style="font-size:12px; color:var(--text-dim);">${statusText}</span>
                        </div>
                        <div style="font-size:14px; margin-bottom:15px; color: #cbd5e1;">
                            –¶–µ–Ω–∞: <b>${lot.price} TON</b><br>
                            –ü–æ—Å–ª–µ —Ö–æ–ª–¥–∞ (-2%): <b style="color:var(--warning);">${getAmount} TON</b>
                        </div>
                        <button class="btn-main btn-small" style="background:#475569; width: 100%;" onclick="changePrice(${lot.id}, '${lot.target_username}')">–ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É</button>
                    </div>
                `}).join('');
            } catch (e) {}
        }

        async function changePrice(lotId, tag) {
            const newPrice = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É –≤ TON –¥–ª—è @${tag}:`);
            if(!newPrice || isNaN(newPrice)) return;
            try {
                await fetch(`${API_URL}/lots/${lotId}/price`, { method: 'PATCH', headers, body: JSON.stringify({ new_price: parseFloat(newPrice) }) });
                tg.showAlert("–¶–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!");
                renderProfile();
                fetchLots();
            } catch(e) { tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ü–µ–Ω—ã"); }
        }

        async function requestWithdraw() {
            // 1. –°–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—É–º–º—É
            const amountStr = prompt(`–°–∫–æ–ª—å–∫–æ TON –≤—ã —Ö–æ—Ç–∏—Ç–µ –≤—ã–≤–µ—Å—Ç–∏?\n–î–æ—Å—Ç—É–ø–Ω–æ: ${document.getElementById('avail-balance').innerText}`);
            if (!amountStr) return;
            const amount = parseFloat(amountStr);
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å –≤ –≤–∏–¥–µ —á–∏—Å–ª–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            const available = parseFloat(document.getElementById('avail-balance').innerText);
            
            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Å—É–º–º—ã
            if (isNaN(amount) || amount <= 0) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!");
            if (amount > available) return tg.showAlert("–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤!");

            // 3. –°–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞
            const wallet = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à TON –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –¥–ª—è –≤—ã–ø–ª–∞—Ç—ã:");
            if (!wallet || wallet.trim().length < 40) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π TON –∞–¥—Ä–µ—Å!");

            // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É –Ω–∞ –±—ç–∫–µ–Ω–¥
            try {
                const res = await fetch(`${API_URL}/withdraw`, {
                    method: 'POST', 
                    headers, 
                    body: JSON.stringify({ user_id: user.id, amount: amount, wallet_address: wallet.trim() })
                });

                if (res.ok) {
                    tg.showAlert(`‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ ${amount} TON —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –µ—ë –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.`);
                    // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã —é–∑–µ—Ä —É–≤–∏–¥–µ–ª, —á—Ç–æ –±–∞–ª–∞–Ω—Å —Å–ø–∏—Å–∞–ª—Å—è –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É
                    fetchUserData();
                } else {
                    const data = await res.json();
                    tg.showAlert(data.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏");
                }
            } catch (e) {
                tg.showAlert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
            }
        }

        // --- –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ö–õ–ê–î–û–ö ---
        function switchTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            element.classList.add('active');
            
            if(tabId === 'profile') { fetchUserData(); renderProfile(); }
            if(tabId === 'market') fetchLots();
        }

        // --- –í–´–°–¢–ê–í–õ–ï–ù–ò–ï –ò –¢–ê–ô–ú–ï–† ---
        function openConfirmModal() {
            const tag = document.getElementById('username-input').value.replace('@', '').trim();
            const price = document.getElementById('price-input').value;
            
            if (!tag || !price) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
            
            document.getElementById('confirm-tag').innerText = tag;
            document.getElementById('confirm-price').innerText = price;
            
            document.getElementById('modal-step-1').style.display = 'block';
            document.getElementById('modal-step-2').style.display = 'none';
            document.getElementById('modal-step-3').style.display = 'none';
            document.getElementById('custom-modal').style.display = 'flex';
        }

        async function confirmAndSend() {
            const tag = document.getElementById('confirm-tag').innerText;
            const price = document.getElementById('confirm-price').innerText;

            try {
                const res = await fetch(`${API_URL}/lots`, {
                    method: 'POST', headers,
                    body: JSON.stringify({ user_id: user.id, target_username: tag, price: parseFloat(price) })
                });

                const data = await res.json();
                if (res.ok) {
                    document.getElementById('modal-step-1').style.display = 'none';
                    document.getElementById('modal-step-2').style.display = 'block';
                    startTimer(data.lot_id); 
                } else {
                    tg.showAlert(data.detail || "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
                    closeModal();
                }
            } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º"); }
        }

        function startTimer(lotId) {
            clearInterval(timerInterval);
            clearInterval(statusInterval);
            
            let time = 300; 
            const el = document.getElementById('countdown');
            el.innerText = "05:00";
            
            timerInterval = setInterval(() => {
                time--;
                let m = Math.floor(time / 60).toString().padStart(2, '0');
                let s = (time % 60).toString().padStart(2, '0');
                el.innerText = `${m}:${s}`;
                if (time <= 0) {
                    clearInterval(timerInterval);
                    clearInterval(statusInterval);
                    closeModal();
                    tg.showAlert("–í—Ä–µ–º—è –≤—ã—à–ª–æ! –ï—Å–ª–∏ –≤—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∏ –ø—Ä–∞–≤–∞, –ª–æ—Ç –æ—Ç–º–µ–Ω–µ–Ω.");
                }
            }, 1000);

            statusInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${API_URL}/lots/${lotId}/status`, { headers });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.status === 'active') {
                            clearInterval(timerInterval);
                            clearInterval(statusInterval);
                            document.getElementById('modal-step-2').style.display = 'none';
                            document.getElementById('modal-step-3').style.display = 'block'; 
                        }
                    }
                } catch(e) {}
            }, 5000);
        }

        function closeModal() { 
            document.getElementById('custom-modal').style.display = 'none'; 
            clearInterval(timerInterval);
            clearInterval(statusInterval);
        }

        function closeModalAndRefresh() {
            closeModal();
            fetchLots();
            if(document.getElementById('tab-profile').classList.contains('active')) renderProfile();
        }

        // --- –ó–ê–©–ò–©–ï–ù–ù–ê–Ø –ü–û–ö–£–ü–ö–ê –° –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–ú ---
// --- –ü–û–ö–£–ü–ö–ê –° –ü–†–û–í–ï–†–ö–û–ô –í–ù–£–¢–†–ï–ù–ù–ï–ì–û –ë–ê–õ–ê–ù–°–ê ---
        async function buyLotWithWallet(lotId, price) {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–µ–Ω—å–≥–∏ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º –±–∞–ª–∞–Ω—Å–µ
            let availElement = document.getElementById('avail-balance');
            let internalBalance = availElement ? parseFloat(availElement.innerText) : 0;

            if (internalBalance >= price) {
                // –î–µ–Ω–µ–≥ —Ö–≤–∞—Ç–∞–µ—Ç! –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ–ø–ª–∞—Ç–∏—Ç—å –±–µ–∑ –±–ª–æ–∫—á–µ–π–Ω–∞
                if (confirm(`–£ –≤–∞—Å –Ω–∞ –±–∞–ª–∞–Ω—Å–µ ${internalBalance} TON.\n–°–ø–∏—Å–∞—Ç—å ${price} TON –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —ç—Ç–æ–≥–æ –ª–æ—Ç–∞?`)) {
                    try {
                        const res = await fetch(`${API_URL}/lots/${lotId}/buy-internal`, {
                            method: 'POST', headers, body: JSON.stringify({ buyer_id: user.id })
                        });
                        const data = await res.json();
                        
                        if (res.ok) {
                            tg.showAlert("‚úÖ –õ–æ—Ç —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω —Å –≤–∞—à–µ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞!");
                            fetchLots();
                            fetchUserData();
                        } else {
                            tg.showAlert(data.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ");
                        }
                    } catch(e) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"); }
                    
                    return; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –≤–Ω–µ—à–Ω–∏–π –∫–æ—à–µ–ª–µ–∫ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ!
                }
            }

            // 2. –ï—Å–ª–∏ –¥–µ–Ω–µ–≥ –Ω–µ—Ç –∏–ª–∏ —é–∑–µ—Ä –æ—Ç–∫–∞–∑–∞–ª—Å—è ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ TonSpace
            if (!tonConnectUI.connected) return tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫!");

            // –°–æ–∑–¥–∞–µ–º –∑–∞—â–∏—Ç–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –±–ª–æ–∫—á–µ–π–Ω–∞ —á–µ—Ä–µ–∑ TonWeb
            const comment = `buy_lot_${lotId}`;
            const cell = new TonWeb.boc.Cell();
            cell.bits.writeUint(0, 32); // 0 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            cell.bits.writeString(comment);
            const payloadBytes = await cell.toBoc(false);
            const payloadBase64 = TonWeb.utils.bytesToBase64(payloadBytes);

            const transaction = {
                validUntil: Math.floor(Date.now() / 1000) + 360,
                messages: [{
                    address: "UQDKJrZT85ZyMPVkc0d2Q3kPIzOb4YEmJSb-oVtAZE-71AaU",
                    amount: (price * 1000000000).toString(),
                    payload: payloadBase64
                }]
            };

            try {
                await tonConnectUI.sendTransaction(transaction);
                tg.showAlert("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ñ–¥–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–µ—Ç–∏...");
                await fetch(`${API_URL}/lots/${lotId}/verify-payment`, {
                    method: 'POST', headers, body: JSON.stringify({ boc: "sent", buyer_id: user.id })
                });
            } catch (e) { tg.showAlert("–û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"); }
        }

        // –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        if (user) {
            fetchUserData();
            fetchLots();
        }

        setInterval(fetchLots, 15000);
    </script>
</body>
</html>
